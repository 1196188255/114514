(this["webpackJsonpbangbangboom-editor"]=this["webpackJsonpbangbangboom-editor"]||[]).push([[0],{226:function(e,t,n){e.exports=n(384)},231:function(e,t,n){},384:function(e,t,n){"use strict";n.r(t);var a=n(0),i=n.n(a),o=n(21),r=n.n(o),s=(n(231),n(113)),l=n(15),c=n(183),m=n(184);const u=new Set;s.a.use(m.a).use(c.a).use(l.a).init({fallbackLng:"en",debug:!1,nsSeparator:"::",interpolation:{escapeValue:!1},backend:{loadPath:"/ebbb/locales/{{lng}}.json"},react:{useSuspense:!1},saveMissing:!0,missingKeyHandler:function(e,t,n){u.add(n)}});const d=window;d.i18n=s.a,d.missingKeys=u;var p=s.a,h=n(455),g=n(454),f=n(427),b=n(426),y=n(425),E=n(100),v=n.n(E),w=n(11),O=n(7);n(65);class j extends Error{}function k(e="Ran into never happen"){throw new j(e)}function _(e){return null!==e&&void 0!==e||k("Assertion for not null or undefined fail"),e}function N(){return 2147483648*Math.random()|0}function S(e){return e&&"object"===typeof e}const x=function(e,t){const n={};let a=!1;for(const i in t)void 0!==t[i]?e[i]!==t[i]&&(n[i]=e[i],e[i]=t[i],a=!0):delete e[i];if(a)return n},C=function e(t,n){if(!S(t)&&!S(n))return;const a={};let i=!1;for(const o in n)if(void 0!==n[o])if(S(n[o])&&S(t[o])){const r=e(t[o],n[o]);r&&(a[o]=r,i=!0)}else t[o]!==n[o]&&(a[o]=t[o],t[o]=n[o],i=!0);else delete t[o];return i?a:void 0};function T(e){const t=[];for(const n of e.entries())t.push(n);return t}function P(e){const t=[];for(const n of e.entries())t.push(n[0]);return t}function L(e){if(e<0)return"-"+L(-e);let t=1e3*e+.5|0,n=t/6e4|0;t=t%6e4|0,n=n+100|0;let a=t/1e3|0;return t=t%1e3|0,a=a+100|0,t=t+1e3|0,n.toString().substr(1)+":"+a.toString().substr(1)+"."+t.toString().substr(1)}function M(e){let t,n=!1;return function(){return n||(n=!0,t=e()),t}}function R(e,t,n){void 0===n&&(n=1),void 0===t&&(t=e,e=0);const a=[];for(;(t-e)*n>0;)a.push(e),e+=n;return a}function A(e){return new Promise((t,n)=>{const a=document.createElement("input");a.type="file",a.accept=e,a.onchange=e=>{let i;if(a.files&&(i=a.files.item(0))){const e=new FileReader;e.onload=n=>t(e.result),e.onerror=e=>n(e),e.readAsText(i)}else n()},a.oncancel=e=>n(),a.click()})}var F,D,B,H,z=n(2);let W=(F=class e{constructor(e){Object(w.a)(this,"timepoints",D,this),Object(w.a)(this,"slides",B,this),Object(w.a)(this,"notes",H,this),this.timepoints=e.timepoints,this.slides=e.slides,this.notes=e.notes}static create(){return new e({timepoints:new Map,slides:new Map,notes:new Map})}static toJsonString(e){const{timepoints:t,slides:n,notes:a}=e,i={timepoints:T(t).map(e=>({...e[1]})),slides:T(n).map(e=>({...e[1]})),notes:T(a).map(e=>({...e[1]}))};return i.timepoints.forEach(e=>delete e.ticktimecache),i.notes.forEach(e=>delete e.realtimecache),JSON.stringify(i)}static fromJson(t){const{timepoints:n,slides:a,notes:i}=JSON.parse(t),o={timepoints:new Map(n.map(e=>[e.id,e])),slides:new Map(a.map(e=>[e.id,e])),notes:new Map(i.map(e=>[e.id,e]))};return a.some(e=>e.notes.some(e=>!o.notes.has(e)))&&k(),i.some(e=>"slide"===e.type&&!o.slides.has(e.slide))&&k(),i.some(e=>!o.timepoints.has(e.timepoint))&&k(),n.forEach(e=>I(e)),i.forEach(e=>$(o,e)),new e(o)}},D=Object(O.a)(F.prototype,"timepoints",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),B=Object(O.a)(F.prototype,"slides",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),H=Object(O.a)(F.prototype,"notes",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),F);function I(e){e.ticktimecache=60/e.bpm/48}function $(e,t){const n=_(e.timepoints.get(t.timepoint));t.realtimecache=n.time+n.ticktimecache*t.offset}function U(e,t){let n=!1;const a=t.notes.slice().sort((t,a)=>{const i=_(e.notes.get(t)).realtimecache-_(e.notes.get(a)).realtimecache;return 0===i&&(n=!0),i});return t.notes=a,n}const Y=(e,t,n,a,i,o)=>{const r=Object(z.g)({type:n,id:t,timepoint:a,offset:i,lane:o,realtimecache:0});return e.notes.set(r.id,r),$(e,r),r},V=(e,t)=>{const n=_(e.notes.get(t));return"single"!==n.type&&"flick"!==n.type&&k(),e.notes.delete(t),n},J=(e,t,n)=>{const a=_(e.notes.get(t));"single"!==a.type&&"flick"!==a.type&&k();const i=x(a,n);if(i)return $(e,a),i},G={Add:(e,t,n,a,i,o)=>{const r=Y(e,t,n,a,i,o);if(r)return e=>V(e,r.id)},Remove:(e,t)=>{const n=V(e,t);if(n)return e=>Y(e,n.id,n.type,n.timepoint,n.offset,n.lane)},Set:(e,t,n)=>{const a=J(e,t,n);if(a)return e=>J(e,t,a)}},X=(e,t,n)=>{const a=Object(z.g)({id:t,flickend:n,notes:[]});return e.slides.set(t,a),a},q=(e,t)=>{const n=_(e.slides.get(t));return n.notes.length>0&&k(),e.slides.delete(t),n},K=(e,t,n)=>{const a=_(e.slides.get(t)),i=x(a,n);if(i)return i},Q={Add:(e,t,n)=>{const a=X(e,t,n);if(a)return e=>q(e,a.id)},Remove:(e,t)=>{const n=q(e,t);if(n)return e=>X(e,n.id,n.flickend)},Set:(e,t,n)=>{const a=K(e,t,n);if(a)return e=>K(e,t,a)}},Z=(e,t,n,a,i,o)=>{const r=Object(z.g)({type:"slide",id:t,slide:n,timepoint:a,offset:i,lane:o,realtimecache:0}),s=_(e.slides.get(n));return s.notes.push(t),e.notes.set(t,r),$(e,r),U(e,s),r},ee=(e,t)=>{const n=_(e.notes.get(t));"slide"!==n.type&&k();const a=_(e.slides.get(n.slide));return a.notes=a.notes.filter(e=>e!==n.id),e.notes.delete(t),U(e,a),n},te=(e,t,n)=>{const a=_(e.notes.get(t));"slide"!==a.type&&k();const i=x(a,n);if(i){$(e,a);const t=_(e.slides.get(a.slide));return U(e,t),i}},ne={Add:(e,t,n,a,i,o)=>{const r=Z(e,t,n,a,i,o);if(r)return e=>ee(e,r.id)},Remove:(e,t)=>{const n=ee(e,t);if(n)return e=>Z(e,n.id,n.slide,n.timepoint,n.offset,n.lane)},Set:(e,t,n)=>{const a=te(e,t,n);if(a)return e=>te(e,t,a)}},ae=(e,t,n,a,i)=>{const o=Object(z.g)({id:t,time:n,bpm:a,bpb:i,ticktimecache:0});return e.timepoints.set(o.id,o),I(o),o},ie=(e,t)=>{const n=_(e.timepoints.get(t));return e.timepoints.delete(t),n},oe=(e,t,n)=>{const a=_(e.timepoints.get(t)),i=x(a,n);if(i)return I(a),i},re={Add:(e,t,n,a,i)=>{const o=ae(e,t,n,a,i);if(o)return e=>ie(e,o.id)},Remove:(e,t)=>{const n=ie(e,t);if(n)return e=>ae(e,n.id,n.time,n.bpm,n.bpb)},Set:(e,t,n)=>{const a=oe(e,t,n);if(a)return e=>oe(e,t,a)}};class se{constructor(e){this.state=e,this.act_done=[],this.act_todo=[],this.act_undo=[]}get canRedo(){return this.act_todo.length>0}get canUndo(){return this.act_undo.length>0}callAtom(e,...t){const n=n=>e(n,...t),a=n(this.state);return!!a&&(this.act_todo.length=0,this.act_done.push(n),this.act_undo.push(a),!0)}undoAtom(){const e=this.act_undo.pop(),t=this.act_done.pop();if(!e||!t){if(!e&&!t)return!1;k("Undo list and done list length not equal")}return e(this.state),this.act_todo.push(t),!0}redoAtom(){const e=this.act_todo.pop();if(!e)return!1;const t=e(this.state);if(t)return this.act_done.push(e),this.act_undo.push(t),!0;k("Can not redo an action.")}doTransaction(e){const t=this.act_done.length;if(e())return this.act_done.length-t;for(;this.act_done.length>t;)this.undoAtom();return 0}doParallel(e){const t=this.act_done.length;return e(),this.act_done.length-t}}var le,ce,me,ue,de,pe,he,ge;let fe=(le=z.b.bound,ce=class{get canUndo(){return this.act_done.length>0}get canRedo(){return this.act_todo.length>0}constructor(e){this.history=void 0,Object(w.a)(this,"state",me,this),Object(w.a)(this,"act_done",ue,this),Object(w.a)(this,"act_todo",de,this),this.changeListeners=new Set,Object(w.a)(this,"ResetState",pe,this),Object(w.a)(this,"Undo",he,this),Object(w.a)(this,"Redo",ge,this),this.history=new se(e),this.state=e}changed(){for(const e of this.changeListeners)e()}done(e){return e>0&&(this.act_todo.length=0,this.act_done.push(e),this.changed(),!0)}},me=Object(O.a)(ce.prototype,"state",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ue=Object(O.a)(ce.prototype,"act_done",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),de=Object(O.a)(ce.prototype,"act_todo",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Object(O.a)(ce.prototype,"canUndo",[z.d],Object.getOwnPropertyDescriptor(ce.prototype,"canUndo"),ce.prototype),Object(O.a)(ce.prototype,"canRedo",[z.d],Object.getOwnPropertyDescriptor(ce.prototype,"canRedo"),ce.prototype),pe=Object(O.a)(ce.prototype,"ResetState",[z.b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e=>{this.state=e,this.history=new se(e),this.act_done=[],this.act_todo=[],this.changed()}}}),he=Object(O.a)(ce.prototype,"Undo",[z.b],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return()=>{const e=this.act_done.pop();if(void 0!==e){this.act_todo.push(e);for(let t=0;t<e;t++)this.history.undoAtom();this.changed()}}}}),ge=Object(O.a)(ce.prototype,"Redo",[le],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return()=>{const e=this.act_todo.pop();if(void 0!==e){this.act_done.push(e);for(let t=0;t<e;t++)this.history.redoAtom();this.changed()}}}}),ce);var be;let ye=(be=class extends fe{get timepointlist(){return T(this.state.timepoints).map(e=>e[1]).sort((e,t)=>e.time-t.time||e.id-t.id)}get slidelist(){return T(this.state.slides).map(e=>e[1])}get notelist(){return T(this.state.notes).map(e=>e[1])}get timepoints(){return this.state.timepoints}get slides(){return this.state.slides}get notes(){return this.state.notes}findTimepoint(e,t){const n=this.timepointlist.filter(e=>e.id!==t);if(n.length<=0)return[void 0,-1];let a=0;for(;a<n.length&&e>=n[a].time;)a++;return a>0&&a--,[n[a],a]}calcNearestPosition(e,t,n){const a=48/t,[i,o]=this.findTimepoint(e,n);if(!i)return;const r=Math.round((e-i.time)/(i.ticktimecache*a))*a,s=i.time+i.ticktimecache*r,[l,c]=this.findTimepoint(s+i.ticktimecache,n);return l&&l.id!==i.id?{timepoint:l,offset:0,timepointIndex:c,realtime:l.time}:{timepoint:i,offset:r,timepointIndex:o,realtime:s}}patchNote(e,t){return"slide"===e.type?this.history.callAtom(ne.Set,e.id,t):this.history.callAtom(G.Set,e.id,t)}justifyFollowChanged(e,t,n){for(const a of e){$(this.state,a);const e=this.calcNearestPosition(a.realtimecache,t,n);e?e.timepoint.id===a.timepoint&&e.offset===a.offset||this.patchNote(a,{timepoint:e.timepoint.id,offset:e.offset}):this.deleteOne(a)}}justifyFindNearest(e,t,n){for(const a of e){const e=this.calcNearestPosition(a.realtimecache,t,n);e?e.timepoint.id===a.timepoint&&e.offset===a.offset||this.patchNote(a,{timepoint:e.timepoint.id,offset:e.offset}):this.deleteOne(a)}}deleteSlideNote(e){if(!this.state.notes.has(e.id))return!1;const t=_(this.state.slides.get(e.slide));if(t.notes.length>2)return this.history.callAtom(ne.Remove,e.id);{const e=t.notes[0],n=t.notes[1];return this.history.doTransaction(()=>this.history.callAtom(ne.Remove,e)&&this.history.callAtom(ne.Remove,n)&&this.history.callAtom(Q.Remove,t.id))>0}}deleteOne(e){return!!this.notes.has(e.id)&&("slide"===e.type?this.deleteSlideNote(e):this.history.callAtom(G.Remove,e.id))}deleteMany(e){for(const t of e)this.deleteOne(t)}},Object(O.a)(be.prototype,"timepointlist",[z.d],Object.getOwnPropertyDescriptor(be.prototype,"timepointlist"),be.prototype),Object(O.a)(be.prototype,"slidelist",[z.d],Object.getOwnPropertyDescriptor(be.prototype,"slidelist"),be.prototype),Object(O.a)(be.prototype,"notelist",[z.d],Object.getOwnPropertyDescriptor(be.prototype,"notelist"),be.prototype),be);var Ee,ve,we,Oe,je,ke,_e,Ne,Se,xe,Ce,Te;let Pe=(Ee=z.b.bound,ve=z.b.bound,we=z.b.bound,Oe=z.b.bound,je=z.b.bound,ke=z.b.bound,_e=z.b.bound,Ne=z.b.bound,Se=z.b.bound,xe=z.b.bound,Ce=z.b.bound,Te=class extends ye{addTimepoint(e,t,n,a){return this.done(this.history.doParallel(()=>{this.history.callAtom(re.Add,N(),e,t,n)&&this.justifyFindNearest(this.notelist,a)}))}moveTimepoint(e,t,n,a,i,o){const r=_(this.state.timepoints.get(e)),s=void 0!==a&&r.time!==a||void 0!==i&&r.bpm!==i;return this.done(this.history.doParallel(()=>{this.history.callAtom(re.Set,e,{time:a,bpm:i,bpb:o})&&s&&(t?this.justifyFindNearest(this.notelist,n):this.justifyFollowChanged(this.notelist,n))}))}removeTimepoint(e,t){return this.state.timepoints.size>1?this.done(this.history.doParallel(()=>{this.justifyFindNearest(this.notelist,t,e),this.history.callAtom(re.Remove,e)})):this.done(this.history.doParallel(()=>{this.deleteMany(this.notelist),this.history.callAtom(re.Remove,e),(this.state.slides.size||this.state.notes.size||this.state.timepoints.size)&&k()}))}addSingle(e,t,n){return this.done(this.history.doTransaction(()=>this.history.callAtom(G.Add,N(),"single",e,t,n)))}toggleFlick(e){return this.done(this.history.doTransaction(()=>this.history.callAtom(G.Set,e.id,{type:"single"===e.type?"flick":"single"})))}addSlide(e,t,n,a,i,o){const r=N();return this.done(this.history.doTransaction(()=>this.history.callAtom(Q.Add,r,!1)&&this.history.callAtom(ne.Add,N(),r,e,t,n)&&this.history.callAtom(ne.Add,N(),r,a,i,o)))}toggleFlickend(e){const t=_(this.state.slides.get(e));return this.done(this.history.doTransaction(()=>this.history.callAtom(Q.Set,e,{flickend:!t.flickend})))}addSlideMid(e,t,n,a){return this.done(this.history.doTransaction(()=>this.history.callAtom(ne.Add,N(),e,t,n,a)))}moveMany(e,t,n,a,i,o){return this.done(this.history.doTransaction(()=>{for(const o of e){const r=o.realtimecache+t,s=o.lane+i;if(r>a||r<n||s<0||s>6){for(const t of e)$(this.state,t);return!1}this.patchNote(o,{lane:s}),o.realtimecache=r}return this.justifyFindNearest(e,o),!0}))}copyMany(e,t,n,a,i,o){return this.done(this.history.doTransaction(()=>{const r={},s={};for(const t of e)"slide"===t.type&&(s[t.slide]=s[t.slide]&&s[t.slide]+1||1);for(const e in s){const t=parseInt(e);if(s[t]>=2){const e=N();this.history.callAtom(Q.Add,e,_(this.state.slides.get(t)).flickend),r[t]=e}}for(const l of e){const e=l.realtimecache+t,s=l.lane+i;if(e>a||e<n||s<0||s>6)return!1;const c=_(this.calcNearestPosition(e,o));if("slide"===l.type){const e=r[l.slide];if(!e)continue;if(!this.history.callAtom(ne.Add,N(),e,c.timepoint.id,c.offset,s))return!1}else{if(!this.history.callAtom(G.Add,N(),l.type,c.timepoint.id,c.offset,s))return!1}}return!0}))}removeNotes(e){return this.done(this.history.doParallel(()=>{this.deleteMany(e)}))}},Object(O.a)(Te.prototype,"addTimepoint",[Ee],Object.getOwnPropertyDescriptor(Te.prototype,"addTimepoint"),Te.prototype),Object(O.a)(Te.prototype,"moveTimepoint",[ve],Object.getOwnPropertyDescriptor(Te.prototype,"moveTimepoint"),Te.prototype),Object(O.a)(Te.prototype,"removeTimepoint",[we],Object.getOwnPropertyDescriptor(Te.prototype,"removeTimepoint"),Te.prototype),Object(O.a)(Te.prototype,"addSingle",[Oe],Object.getOwnPropertyDescriptor(Te.prototype,"addSingle"),Te.prototype),Object(O.a)(Te.prototype,"toggleFlick",[je],Object.getOwnPropertyDescriptor(Te.prototype,"toggleFlick"),Te.prototype),Object(O.a)(Te.prototype,"addSlide",[ke],Object.getOwnPropertyDescriptor(Te.prototype,"addSlide"),Te.prototype),Object(O.a)(Te.prototype,"toggleFlickend",[_e],Object.getOwnPropertyDescriptor(Te.prototype,"toggleFlickend"),Te.prototype),Object(O.a)(Te.prototype,"addSlideMid",[Ne],Object.getOwnPropertyDescriptor(Te.prototype,"addSlideMid"),Te.prototype),Object(O.a)(Te.prototype,"moveMany",[Se],Object.getOwnPropertyDescriptor(Te.prototype,"moveMany"),Te.prototype),Object(O.a)(Te.prototype,"copyMany",[xe],Object.getOwnPropertyDescriptor(Te.prototype,"copyMany"),Te.prototype),Object(O.a)(Te.prototype,"removeNotes",[Ce],Object.getOwnPropertyDescriptor(Te.prototype,"removeNotes"),Te.prototype),Te);const Le={name:""},Me={general:{song_volume:1,effect_volume:1,background_dim:.7},editor:{keep_pitch:!1,justify_find_nearest:!0,justify_grid_divisor:48,show_info_window:!0,warn_for_same_pos_notes:!0,autosave_interval:5},game:{skin:"default",judge_offset:0,visual_offset:0,speed:10,resolution:1.25,note_scale:1,bar_opaciry:.9,show_sim_line:!0,lane_effect:!0,mirror:!1,beat_note:!0}};var Re,Ae,Fe,De,Be;const He="editor:meta",ze="editor:mapcontent",We="editor:settings";const Ie=new(Re=class{constructor(){this.map=void 0,Object(w.a)(this,"lastSave",Ae,this),this.save=()=>{const e=W.toJsonString(this.map.state);localStorage.setItem(ze,e),this.lastSave=new Date},Object(w.a)(this,"update",Fe,this),this.reset=e=>{this.map.ResetState(e||W.create())},Object(w.a)(this,"meta",De,this),Object(w.a)(this,"settings",Be,this);const e=localStorage.getItem(ze);let t=null;if(e)try{t=W.fromJson(e)}catch(i){localStorage.removeItem(ze),console.error(i)}t||(t=W.create()),this.map=new Pe(t);const n=localStorage.getItem(He);this.meta=Object(z.g)(Le),n&&C(this.meta,JSON.parse(n)),Object(z.c)(()=>{const e=JSON.stringify(this.meta);localStorage.setItem(He,e)});const a=localStorage.getItem(We);this.settings=Object(z.g)(Me),a&&C(this.settings,JSON.parse(a)),Object(z.c)(()=>{const e=JSON.stringify(this.settings);localStorage.setItem(We,e)}),this.map.changeListeners.add(()=>{this.settings.editor.autosave_interval>0&&setTimeout(()=>{const e=(new Date).getTime(),t=60*this.settings.editor.autosave_interval*1e3;(!this.lastSave||e-this.lastSave.getTime()>t)&&this.save()},60*this.settings.editor.autosave_interval*1e3-1e3)})}},Ae=Object(O.a)(Re.prototype,"lastSave",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fe=Object(O.a)(Re.prototype,"update",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),De=Object(O.a)(Re.prototype,"meta",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Be=Object(O.a)(Re.prototype,"settings",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Re);window.AudioContext=window.AudioContext||window.webkitAudioContext;var $e=AudioContext&&new class{constructor(){this._ctx=void 0,this._output=void 0,this._ctx=new AudioContext,this._output=this._ctx.createGain(),this._output.connect(this._ctx.destination)}get ctx(){return this._ctx}get now(){return this._ctx.currentTime}get latency(){return this._ctx.baseLatency+this._ctx.outputLatency}get mastervolume(){return this._output.gain}get destination(){return this._output}};class Ue{constructor(){this.listeners=new Set,this.add=e=>(this.listeners.add(e),()=>this.listeners.delete(e)),this.dispatch=(...e)=>{const t=[];for(const n of this.listeners)t.push(n);t.forEach(t=>t(()=>this.listeners.delete(t),...e))},this.dispose=()=>this.listeners.clear()}}class Ye{constructor(){this.gain=void 0,this.buffer=void 0,this.onload=new Ue,this.onloaderr=new Ue,this.load=()=>this,this.gain=$e.ctx.createGain(),this.gain.connect($e.destination)}get destination(){return this.gain}get volume(){return Math.sqrt(this.gain.gain.value)}set volume(e){this.gain.gain.value=e*e}get loaded(){return!!this.buffer}get duration(){return this.buffer?this.buffer.duration:0}static from(e){const t=new Ye,n=e=>t.onloaderr.dispatch(e),a=e=>{if(e instanceof Blob){const t=new FileReader;t.onabort=n,t.onerror=n,t.onload=e=>{t.result instanceof ArrayBuffer?a(t.result):n(e)},t.readAsArrayBuffer(e)}else $e.ctx.decodeAudioData(e,e=>{t.buffer=e,t.onload.dispatch()},n)};return t.load=()=>{const i=e instanceof Function?e():e;return i instanceof Promise?i.then(a).catch(n):a(i),t},t}}class Ve{constructor(e){this.source=void 0,this.gain=void 0,this.node=void 0,this._playing=!1,this._starttime=0,this._startpos=0,this._playbackrate=1,this.onplay=new Ue,this.onpause=new Ue,this.onseek=new Ue,this.onend=new Ue,this.callstart=e=>{const t=$e.now+e;this.node.start(t,this._startpos);const n=this._startpos/this._playbackrate;this._starttime=t-n,this._playing=!0},this.handleNormalEnd=()=>{this._startpos=0,this._playing=!1,this.node=this.createnode(),this.onend.dispatch()},this.handlePauseEnd=()=>{this._startpos=this.position,this._playing=!1,this.node=this.createnode(),this.onpause.dispatch()},this.handleSeekEnd=()=>{this.node=this.createnode(),this.node.onended=this.handleNormalEnd,this.callstart(0),this.onseek.dispatch()},this.source=e,this.gain=$e.ctx.createGain(),this.gain.connect(e.destination),this.node=this.createnode()}get volume(){return Math.sqrt(this.gain.gain.value)}set volume(e){this.gain.gain.value=e*e}createnode(){const e=$e.ctx.createBufferSource();return e.buffer=this.source.buffer,e.connect(this.gain),e.playbackRate.value=this._playbackrate,e}get position(){if(!this._playing)return this._startpos;return($e.now-this._starttime)*this._playbackrate}play(e=0){this._playing||(this.callstart(e),this.node.onended=this.handleNormalEnd,this.onplay.dispatch())}stop(e=0){this._playing?(this.node.onended=this.handleNormalEnd,this.node.stop($e.now+e)):this._startpos=0}pause(e=0){this._playing&&(this.node.onended=this.handlePauseEnd,this.node.stop($e.now+e))}seek(e){if(e=Math.max(0,Math.min(this.source.duration,e)),!this._playing)return this._startpos=e,void this.onseek.dispatch();this._startpos=e;const t=this._startpos/this._playbackrate;this._starttime=$e.now-t,this.node.onended=this.handleSeekEnd,this.node.stop($e.now)}get rate(){return this._playbackrate}setRate(e){e=Math.max(.25,Math.min(4,e));const t=this.position;if(this._playbackrate=e,this.node.playbackRate.value=this._playbackrate,this._playing){const n=$e.now,a=t/e;this._starttime=n-a}}}class Je{constructor(e){this._loaded=!1,this.onload=new Ue,this.onloaderr=new Ue,this.source=void 0,this.el=void 0,this.onplay=new Ue,this.onpause=new Ue,this.onseek=new Ue,this.onend=new Ue,this.source=e,this.el=document.createElement("audio"),this.el.oncanplaythrough=e=>{this.el.oncanplaythrough=null,this._loaded=!0,this.onload.dispatch()},this.el.onerror=e=>this.onloaderr.dispatch(e),this.el.preservesPitch=!0,this.el.onended=e=>{this.onend.dispatch(),this.el.currentTime=0},this.el.src=URL.createObjectURL(e),this.el.load()}get loaded(){return this._loaded}get duration(){return this.el.duration}get volume(){return this.el.volume}set volume(e){this.el.volume=e}get position(){return this.el.currentTime}play(e=0){this.el.play(),this.onplay.dispatch()}stop(e=0){this.el.pause(),this.el.currentTime=0,this.onend.dispatch()}pause(e=0){this.el.pause(),this.onpause.dispatch()}seek(e){this.el.currentTime=e,this.onseek.dispatch()}get rate(){return this.el.playbackRate}setRate(e){e=Math.max(.25,Math.min(4,e)),this.el.playbackRate=e}}var Ge,Xe,qe,Ke,Qe,Ze,et,tt;async function nt(e){const t=await fetch(e);return await t.arrayBuffer()}const at=new(Ge=class{constructor(){Object(w.a)(this,"src",Xe,this)}},Xe=Object(O.a)(Ge.prototype,"src",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ge);const it=new(qe=class{constructor(){Object(w.a)(this,"audio",Ke,this),Object(w.a)(this,"duration",Qe,this),Object(w.a)(this,"playing",Ze,this),Object(w.a)(this,"playbackrate",et,this),Object(w.a)(this,"seekcounter",tt,this),this.musicfile=null,this.load=(e,t,n)=>{const a=this;if(null!==a.audio&&a.audio.stop(),a.audio=null,a.duration=5,a.playing=!1,a.seekcounter=1,a.musicfile=null,Ie.settings.editor.keep_pitch){const i=new Je(e);return i.onload.add(()=>{this.musicfile=e,a.duration=i.duration,i.setRate(this.playbackrate),n(),this.audio=i,this.audio.onend.add(()=>{this.playing=!1})}),void i.onloaderr.add(e=>{console.error(e),t()})}const i=Ye.from(e);i.onload.add(()=>{this.musicfile=e,a.duration=i.duration,n(),this.audio=new Ve(i),this.audio.setRate(this.playbackrate),this.audio.onend.add(()=>{this.playing=!1})}),i.onloaderr.add(e=>{console.error(e),t()}),i.load()},this.position=()=>this.audio&&this.seekcounter?this.audio.position:1,this.remaintime=()=>(this.duration-this.position())/this.playbackrate,this.seek=e=>{if(!this.audio)return;const t=this.duration;e<0&&(e=0),e>=t&&(e=t-.05),this.audio.seek(e),this.seekcounter++},this.toggle=()=>{this.audio&&(this.playing?(this.audio.pause(),this.playing=!1):(this.audio.play(),this.playing=!0))},this.stop=()=>{this.audio&&this.audio.stop()},Object(z.c)(()=>{this.audio&&(this.audio.setRate(this.playbackrate),this.audio.volume=Ie.settings.general.song_volume)})}get loaded(){return null!==this.audio}},Ke=Object(O.a)(qe.prototype,"audio",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qe=Object(O.a)(qe.prototype,"duration",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Ze=Object(O.a)(qe.prototype,"playing",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),et=Object(O.a)(qe.prototype,"playbackrate",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tt=Object(O.a)(qe.prototype,"seekcounter",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qe);var ot=n(8);const rt=v()(e=>({background:{position:"absolute",zIndex:-1,top:0,left:0,right:0,bottom:0,backgroundPosition:"center",backgroundRepeat:"no-repeat",transition:"opacity 0.3s",backgroundSize:"cover"}}));var st=()=>{const e=rt();return Object(ot.a)(()=>i.a.createElement(h.a,{className:e.background,style:{backgroundImage:at.src?`url(${at.src})`:"",opacity:1-Ie.settings.general.background_dim}}))},lt=n(208),ct=n(112),mt=n(110);const ut=Object(lt.a)({palette:{primary:{main:ct.a[500],contrastText:"white"},secondary:{main:mt.a.A200},error:mt.a,type:"dark",background:{default:"#000"}},overrides:{MuiButton:{root:{textTransform:"inherit",transition:"color 0.2s"}},MuiTab:{root:{textTransform:"inherit",minWidth:"96px !important"}},MuiSnackbarContent:{root:{color:"#fff"}},MuiTableRow:{root:{"&$selected":{background:"rgb(128,216,255,0.16)","&:hover":{background:"rgb(128,216,255,0.16)"}}}},MuiDivider:{root:{height:2,backgroundColor:"rgba(127, 127, 127, 0.5)"}}}});var dt=n(442),pt=n(463),ht=n(429),gt=n(430),ft=n(436),bt=n(437),yt=n(464);const Et=Object(b.a)(e=>({paper:{width:"calc(60vw + 200px)"}})),vt=Object(z.g)({open:!1,content:"",title:"",copy:""}),wt=Object(z.b)((function(e,t,n=t){vt.open=!0,vt.content=t,vt.title=e,vt.copy=n})),Ot=()=>{navigator.clipboard.writeText(vt.copy)},jt=e=>{e.target.select()};var kt=()=>{const e=Et(),{t:t}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(pt.a,{open:vt.open,onClose:()=>vt.open=!1,classes:{paper:e.paper}},i.a.createElement(ht.a,null,vt.title),i.a.createElement(gt.a,null,i.a.createElement(yt.a,{autoFocus:!0,onFocus:jt,fullWidth:!0,multiline:!0,rowsMax:20,variant:"outlined",value:vt.content})),i.a.createElement(ft.a,null,i.a.createElement(bt.a,{onClick:Ot,color:"primary"},t("Copy")),i.a.createElement(bt.a,{onClick:()=>vt.open=!1,color:"primary"},t("Close")))))},_t=n(4),Nt=n(185),St=n.n(Nt),xt=n(187),Ct=n.n(xt),Tt=n(188),Pt=n.n(Tt),Lt=n(189),Mt=n.n(Lt),Rt=n(438),At=n(439),Ft=n(111),Dt=n(390),Bt=n(460),Ht=n(440),zt=n(186),Wt=n.n(zt);const It={success:St.a,warning:Wt.a,error:Ct.a,info:Pt.a},$t=Object(z.g)({message:"",open:!1,type:"info"}),Ut=Object(b.a)(e=>({success:{backgroundColor:Rt.a[700]},error:{backgroundColor:mt.a[600]},info:{backgroundColor:At.a[600]},warning:{backgroundColor:Ft.a[700]},icon:{fontSize:20},iconVariant:{opacity:.9,marginRight:e.spacing(1)},message:{display:"flex",alignItems:"center"}}));function Yt(e,t="info"){$t.message=e,$t.type=t,$t.open=!0}const Vt=(e,t)=>{"clickaway"!==t&&($t.open=!1)};var Jt=()=>{const e=Ut(),t=It[$t.type];return Object(ot.a)(()=>i.a.createElement(Bt.a,{anchorOrigin:{vertical:"bottom",horizontal:"center"},open:$t.open,autoHideDuration:5e3,onClose:Vt,key:$t.message+$t.type},i.a.createElement(Ht.a,{className:e[$t.type],message:i.a.createElement("span",{className:e.message},i.a.createElement(t,{className:Object(_t.a)(e.icon,e.iconVariant)}),$t.message),action:[i.a.createElement(Dt.a,{key:"close","aria-label":"close",color:"inherit",onClick:Vt},i.a.createElement(Mt.a,{className:e.icon}))]})))};function Gt(e,t){for(let n=30;n<=6e4;n++){const a=60/n,i=e/a;let o=i+.5|0;if((i>o?i-o:o-i)*a<=.001){if(t%n===0){const e=t/n;n*=e,o*=e}return{bpm:n,beatcount:o}}}}function Xt(e){const t=T(e.timepoints).map(e=>e[1]).sort((e,t)=>e.time-t.time);if(t.length<=0)return"[]";const n=new Set,a=T(e.notes).map(e=>e[1]).sort((e,t)=>{const n=e.realtimecache-t.realtimecache;return n||e.lane-t.lane}),i=[];let o=t[0],r=0;{if(o.bpm!==(0|o.bpm))throw new Error("Can not have float point bpm");const e=Gt(o.time,o.bpm);if(!e)throw new Error("Can not calculate bpm insertion");e.bpm===o.bpm||e.beatcount<=0?i.push({type:"System",cmd:"BPM",beat:0,bpm:o.bpm}):(i.push({type:"System",cmd:"BPM",beat:0,bpm:e.bpm}),i.push({type:"System",cmd:"BPM",beat:e.beatcount,bpm:o.bpm})),r=e.beatcount,n.add(o)}let s=0,l=r;const c=function(){let e=null,t=0,n=null,a=0;return{start(i,o){if(null===e&&o>t)return e=i,"A";if(null===n&&o>a)return n=i,"B";throw new Error("Can not use 3 slides at same time")},mid(t){if(e===t)return"A";if(n===t)return"B";throw new Error("Map may be corrupted")},end(i,o){if(e===i)return e=null,t=o,"A";if(n===i)return n=null,a=o,"B";throw new Error("Map may be corrupted")}}}();for(;s<a.length;){const t=a[s++],m=e.timepoints.get(t.timepoint);if(!m)throw new Error("Map may be corrupted");if(!n.has(m)){if(m.bpm!==(0|m.bpm))throw new Error("Can not have float point bpm");l=1048575-(1048575-l|0);const e=(l-r)*o.ticktimecache*48+o.time,t=Gt(m.time-e,m.bpm);if(!t)throw new Error("Can not calculate bpm insertion");t.bpm===m.bpm||t.beatcount<=0?(r=l+t.beatcount,i.push({type:"System",cmd:"BPM",beat:r,bpm:m.bpm})):(r=l+t.beatcount,i.push({type:"System",cmd:"BPM",beat:l,bpm:t.bpm}),i.push({type:"System",cmd:"BPM",beat:r,bpm:m.bpm})),o=m,l=r,n.add(m)}if(o!==m)throw new Error("Map may be corrupted");const u={type:"Note",beat:r+t.offset/48,lane:t.lane+1};switch(l=u.beat,t.type){case"single":i.push({...u,note:"Single"});break;case"flick":i.push({...u,note:"Single",flick:!0});break;case"slide":const n=e.slides.get(t.slide);if(!n)throw new Error("Map may be corrupted");const a={...u,note:"Slide",pos:"A"};n.notes[0]===t.id?(a.start=!0,a.pos=c.start(n.id,u.beat)):n.notes[n.notes.length-1]===t.id?(a.end=!0,a.pos=c.end(n.id,u.beat),n.flickend&&(a.flick=!0)):a.pos=c.mid(n.id),i.push(a)}}return function(e){const t=[];t.push("[");for(let n=0;n<e.length;n++){const a=e[n];t.push(JSON.stringify(a)),n!==e.length-1&&t.push(",\n")}return t.push("]"),t.join("")}(i)}var qt=n(441);const Kt=Object(z.g)({open:!1,title:"",content:"",confirm:()=>{}}),Qt=Object(z.b)((e,t,n)=>{Kt.open=!0,Kt.content=t,Kt.title=e,Kt.confirm=n});var Zt=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(pt.a,{open:Kt.open,onClose:()=>Kt.open=!1},i.a.createElement(ht.a,null,Kt.title),i.a.createElement(gt.a,null,i.a.createElement(qt.a,null,Kt.content)),i.a.createElement(ft.a,null,i.a.createElement(bt.a,{onClick:()=>Kt.open=!1,color:"primary",autoFocus:!0},e("Cancel")),i.a.createElement(bt.a,{onClick:()=>{Kt.confirm(),Kt.open=!1},color:"secondary"},e("Reset")))))};function en(e){return{time:parseFloat(e[1]),bpm:parseFloat(e[2]),bpb:parseInt(e[3]),id:N(),ticktimecache:0}}function tn(e){const t=e.split(":");return{offset:2*parseInt(t[0]),lane:parseInt(t[1])}}function nn(e,t){return{type:"single",id:N(),timepoint:t,...tn(e[1]),realtimecache:0}}function an(e,t){return{type:"flick",id:N(),timepoint:t,...tn(e[1]),realtimecache:0}}function on(e,t){const n={id:N(),flickend:"1"===e[1],notes:[]},a=[];for(let i=2;i<e.length;i++){const o={type:"slide",id:N(),timepoint:t,...tn(e[i]),realtimecache:0,slide:n.id};n.notes.push(o.id),a.push(o)}return[n,a]}const rn=async()=>{try{const e=await A("*");Ie.reset(function(e){const t=e.split(/\r?\n/).map(e=>e.trim()).filter(e=>e),n=[],a=[],i=[];let o;for(const r of t){const e=r.split("|");switch(e[0]){case"+":o=en(e),I(o),n.push(o);break;case"s":i.push(nn(e,o.id));break;case"f":i.push(an(e,o.id));break;case"l":{const[t,n]=on(e,o.id);a.push(t),i.push(...n);break}}}return W.fromJson(JSON.stringify({timepoints:n,slides:a,notes:i}))}(e)),Yt(p.t("Import success"),"success")}catch(e){if(!e)return;throw Yt(p.t("Error import"),"error"),e}},sn=()=>{try{const e=Xt(Ie.map.state);wt(p.t("Export Bestdori format map"),e)}catch(e){throw wt(p.t("An error occurred during export"),p.t(""+e)),Yt(p.t("Error export"),"error"),e}},ln=()=>{try{const e=function(e){const t=T(e.timepoints).map(e=>e[1]).sort((e,t)=>e.time-t.time);if(!t||0===t.length)return"[]";const n=T(e.notes).map(e=>e[1]).sort((e,t)=>{const n=e.realtimecache-t.realtimecache;return n||e.lane-t.lane}),a=new Array;if(0!==t[0].time){const e=t[0].bpm;let n={bpm:1,time:0};for(n.bpm=1;n.bpm<=6e4;n.bpm++){const a=60/n.bpm,i=n.time/a;let o=i+.5|0;if((i>o?i-o:o-i)*a<=.001){if(e%n.bpm===0){const t=e/n.bpm;n.bpm*=t,o*=t}t.push(n);break}}}let i,o=0,r={A:null,B:null,C:null};for(const s of t){const t=i?Math.round(1e4*(o+(s.time-i.time)/(60/i.bpm)))/1e4:0;a.push({type:"System",cmd:"BPM",bpm:s.bpm,beat:t}),o=t,i=s;const l=n.filter(e=>e.timepoint===s.id).sort((e,t)=>e.offset-t.offset);for(const n of l){let i={type:"Note",beat:Math.round(1e4*(n.offset/48+t))/1e4,lane:n.lane+1};switch(n.type){case"single":i={...i,note:"Single"};break;case"flick":i={...i,note:"Single",flick:!0};break;case"slide":const t=e.slides.get(n.slide);if(!t)throw new Error(`At timepoint: time ${s.time}, note: offset ${Math.floor(Math.floor(n.offset/48)/s.bpb)+1}:${Math.floor(n.offset/48)%s.bpb+1}.${n.offset%48}, unknown slide group, map maybe corrupted`);let a;for(const e in r)if(!r[e]||r[e]===t.id){console.log("Pos",e,"Set Slide Group",t.id),r[e]=t.id,a=e;break}if(!a)throw new Error(`At timepoint: time ${s.time}, note: offset ${Math.floor(Math.floor(n.offset/48)/s.bpb)}:${Math.floor(n.offset/48)%s.bpb+1}.${n.offset%48}, not allow 3 or more slides`);if(t.notes.length<2)throw new Error(`At timepoint: time ${s.time}, note: offset ${Math.floor(Math.floor(n.offset/48)/s.bpb)+1}:${Math.floor(n.offset/48)%s.bpb+1}.${n.offset%48}, less than 2 notes in this slide group`);t.notes[0]===n.id?i={...i,note:"Slide",start:!0}:t.notes[t.notes.length-1]===n.id?(i={...i,note:"Slide",end:!0,flick:!!t.flickend||void 0},r[a]=null,console.log("Pos",a,"Set NULL")):i={...i,note:"Slide"};break;default:continue}a.push(i)}}return a.sort((e,t)=>e.beat>t.beat||e.beat===t.beat&&e.lane&&t.lane&&e.lane>t.lane?-1:e.beat!==t.beat||"Note"!==e.type||"Slide"!==e.note||"BPM"!==t.cmd||e.end?0:-1),JSON.stringify(a)}(Ie.map.state);wt(p.t("Export Bestdori format map"),e)}catch(e){throw wt(p.t("An error occurred during export"),p.t(""+e)),Yt(p.t("Error export"),"error"),e}},cn=()=>{Qt(p.t("Are you sure to reset current map?"),p.t("This action can not be reverted. Please make sure you have backed up your map."),()=>{Ie.reset(),Yt(p.t("Reset success"),"success")})},mn=()=>{!function(e){"string"===typeof e&&(e=new Blob([e]));const t=URL.createObjectURL(e),n=document.createElement("a");n.style.display="none",n.href=t,n.download=(Ie.meta.name||"No title")+" - bbbEditor.json",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}(W.toJsonString(Ie.map))},un=async()=>{try{const e=await A("*");Ie.reset(W.fromJson(e)),Yt(p.t("Import success"),"success")}catch(e){if(!e)return;throw Yt(p.t("Error import"),"error"),e}};let dn=!1;const pn=async()=>{let e=!1;try{if(dn)throw new Error("There is already a chart being uploaded");if(e=!0,dn=!0,!it.musicfile)throw new Error("No audio import");Yt(p.t("Uploading audio"),"info");const t=n(149),a=new FormData;a.append("file",it.musicfile);let i=(await t.post("https://editor.reikohaku.fun/test/upload/music",a,{headers:{"Content-Type":"multipart/form-data"}})).data;if(!i.result)throw new Error(i.error);Yt(p.t("Uploading chart"),"info");let o=(await t.post("https://editor.reikohaku.fun/test/upload/chart",Ie.map.state,{params:{title:encodeURI(Ie.meta.name),audio:i.id}})).data;if(!o.result)throw new Error(o.error);dn=!1,Yt(p.t("Upload successfully",{id:o.id}),"success"),wt(p.t("Test in BanG Player"),p.t("Test Tips",{id:o.id}),`${o.id}`)}catch(t){if(e&&(dn=!1),!t)return;throw Yt(p.t(t.message),"error"),t}};let hn=!1;const gn=async()=>{let e=!1;try{if(hn)throw new Error("There is already a chart being uploaded");e=!0,hn=!0;const t=JSON.parse(Xt(Ie.map.state));if(!it.musicfile)throw new Error("No audio import");Yt(p.t("Uploading audio"),"info");const a=n(149),i=new FormData;i.append("file",it.musicfile);let o=(await a.post("https://upload.ayachan.fun:24444/Sonolus",i,{headers:{"Content-Type":"multipart/form-data"}})).data;if(!o.result)throw new Error(o.error);Yt(p.t("Uploading chart"),"info");let r=(await a.post("https://api.ayachan.fun/Sonolus/Upload",{notes:t,bgm:o.filename,title:Ie.meta.name,"g-recaptcha-response":"77A22C8B6AE99D04"})).data;if(!r.result)throw new Error(r.error);hn=!1,Yt(p.t("Upload successfully",{id:r.id}),"success"),wt(p.t("Test in Aya Sonolus Server"),p.t("Test Tips of Aya Sonolus Server",{id:r.id}),`${r.id}`)}catch(t){if(e&&(hn=!1),!t)return;throw Yt(p.t(t.message),"error"),t}};var fn=()=>{const{t:e}=Object(l.b)();return i.a.createElement(dt.a,{style:{margin:"20px 0"},item:!0,container:!0,direction:"column",spacing:2},i.a.createElement(dt.a,{item:!0},i.a.createElement(bt.a,{fullWidth:!0,variant:"outlined",onClick:rn},e("Import bangbangboom format v1 (current map will loss)"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(bt.a,{fullWidth:!0,variant:"outlined",onClick:sn},e("Export Bestdori format map"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(bt.a,{fullWidth:!0,variant:"outlined",onClick:ln},e("Export Bestdori format map(New)"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(bt.a,{fullWidth:!0,variant:"outlined",onClick:mn},e("Download editor format map"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(bt.a,{fullWidth:!0,variant:"outlined",onClick:un},e("Import editor format map (current map will loss)"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(bt.a,{fullWidth:!0,variant:"outlined",onClick:cn},e("Reset current map"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(bt.a,{fullWidth:!0,variant:"outlined",onClick:pn},e("Upload to test server"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(bt.a,{fullWidth:!0,variant:"outlined",onClick:gn},e("Upload to Aya Sonolus server"))))},bn=n(190),yn=n.n(bn),En=n(191),vn=n.n(En);var wn=Object(a.forwardRef)((e,t)=>{const{onFileSelected:n,inputProps:o,multiple:r=!1,accept:s,value:l="",...c}=e,[m,u]=Object(a.useState)(l),d=Object(a.useCallback)((e,t)=>{if(e.files&&e.files.length){const n=Array.from(e.files);u(n.map(e=>e.name).join(", ")),t&&t(n)}},[]),p=Object(a.useMemo)(()=>{const e=document.createElement("input");return e.type="file",e},[]);return i.a.createElement(yt.a,Object.assign({},c,{ref:t,inputProps:{...o,onClick:()=>{p.accept=s||"*",p.multiple=r,p.onchange=()=>d(p,n),p.click()}},value:m}))});const On=({children:e})=>i.a.createElement(dt.a,{item:!0,container:!0,spacing:2,alignItems:"flex-end"},i.a.createElement(dt.a,{item:!0},i.a.createElement(yn.a,null)),i.a.createElement(dt.a,{item:!0,xs:!0},e)),jn=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(dt.a,{item:!0,container:!0,spacing:2,alignItems:"flex-end"},i.a.createElement(dt.a,{item:!0},i.a.createElement(vn.a,null)),i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(yt.a,{fullWidth:!0,label:e("Map name"),value:Ie.meta.name,onChange:e=>Ie.meta.name=e.target.value}))))};let kn="";const _n=e=>{kn=e[0].name,it.load(e[0],()=>Yt(p.t("Load failed"),"error"),()=>Yt(p.t("Load success"),"success"))},Nn=()=>{const{t:e}=Object(l.b)();return i.a.createElement(On,null,i.a.createElement(wn,{fullWidth:!0,value:kn,label:e("Load music"),accept:"audio/*",onFileSelected:_n}))};let Sn="";const xn=e=>{Sn=e[0].name;const t=URL.createObjectURL(e[0]);at.src=t},Cn=()=>{const{t:e}=Object(l.b)();return i.a.createElement(On,null,i.a.createElement(wn,{fullWidth:!0,value:Sn,label:e("Load background"),accept:"image/*",onFileSelected:xn}))};var Tn=()=>i.a.createElement(i.a.Fragment,null,i.a.createElement(jn,null),i.a.createElement(Nn,null),i.a.createElement(Cn,null)),Pn=n(89),Ln=n(443);const Mn=Object(b.a)(()=>({panel:{width:"100%",maxWidth:600,margin:"64px auto"}})),Rn=()=>i.a.createElement(dt.a,{item:!0},i.a.createElement(Pn.a,{align:"right",color:"textSecondary"},i.a.createElement(Ln.a,{target:"_blank",rel:"noopener noreferrer",href:"https://bestdori.com"},"Bestdori"),"\xa0|\xa0",i.a.createElement(Ln.a,{target:"_blank",rel:"noopener noreferrer",href:"https://cn.bangplayer.live"},"BanG Player v2 \u4e2d\u56fd\u7248"),"\xa0|\xa0",i.a.createElement(Ln.a,{target:"_blank",rel:"noopener noreferrer",href:"https://github.com/K024/bangbangboom-editor"},"About bangbangboom editor & translations"))),An=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>Ie.update)?i.a.createElement(dt.a,{item:!0},i.a.createElement(h.a,{p:1,fontWeight:"fontWeightLight",fontFamily:"sans-serif",fontStyle:"italic",textAlign:"center"},e("An update is available. Please close ALL tabs of this site or press Ctrl + F5 reload."))):null};var Fn=()=>{const e=Mn();return i.a.createElement(dt.a,{className:e.panel,container:!0,direction:"column",spacing:4},i.a.createElement(An,null),i.a.createElement(Tn,null),i.a.createElement(fn,null),i.a.createElement(Rn,null),i.a.createElement(kt,null),i.a.createElement(Zt,null))},Dn=n(444),Bn=n(445),Hn=n(446),zn=n(447),Wn=n(448);const In=Object(z.g)({bpm:90,bpb:4,time:0,selected:null,muteticker:!1,measuring:!1,autoswitchtp:!0});Object(z.h)(()=>In.selected,Object(z.b)(e=>{if(null!==e){const t=Ie.map.timepoints.get(e);if(!t)return void(In.selected=null);In.bpm=t.bpm,In.bpb=t.bpb,In.time=t.time}}));const $n=Object(b.a)(e=>({table:{maxHeight:"60vh",overflow:"auto","-webkit-overflow-scrolling":"touch"},tablerow:{cursor:"pointer"}})),Un=()=>{const e=$n(),{t:t}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(Dn.a,{className:e.table},i.a.createElement(Bn.a,null,i.a.createElement(Hn.a,null,i.a.createElement(zn.a,null,t("Start time")),i.a.createElement(zn.a,null,"BPM"),i.a.createElement(zn.a,null,t("Meter")))),i.a.createElement(Wn.a,null,Ie.map.timepointlist.map(t=>i.a.createElement(Hn.a,{key:t.id,selected:t.id===In.selected,hover:!0,onClick:()=>In.selected=t.id===In.selected?null:t.id,classes:{root:e.tablerow}},i.a.createElement(zn.a,null,L(t.time)),i.a.createElement(zn.a,null,t.bpm),i.a.createElement(zn.a,null,t.bpb,"/4"))))))},Yn=()=>{null!==In.selected&&(Ie.map.removeTimepoint(In.selected,Ie.settings.editor.justify_grid_divisor),In.selected=null)},Vn=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(bt.a,{color:"secondary",disabled:null===In.selected,onClick:Yn},e("Remove")))};var Jn=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(dt.a,{item:!0,xs:12,sm:!0,container:!0,spacing:2,direction:"column"},i.a.createElement(dt.a,{item:!0},i.a.createElement(Pn.a,null,e("Timepoints"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(Un,null)),i.a.createElement(dt.a,{item:!0},i.a.createElement(Vn,null))))};const Gn={note_flick:"/assets/mapping/note_flick.png",note_long:"/assets/mapping/note_long.png",note_normal:"/assets/mapping/note_normal.png",note_slide_among:"/assets/mapping/note_slide_among.png",timing_tack:"/assets/mapping/timing_tack.wav",timing_tick:"/assets/mapping/timing_tick.wav",perfect:"/assets/mapping/perfect.mp3",flick:"/assets/mapping/flick.mp3",long:"/assets/mapping/long.mp3"};for(const Zr in Gn)Gn[Zr]="/ebbb"+Gn[Zr];var Xn=Gn,qn=n(128);function Kn(e){let t=!1;const n=()=>{t=!0},a=()=>{t||(requestAnimationFrame(a),e(n))};return requestAnimationFrame(a),n}function Qn(e,t){return Object(qn.a)(e,t),function(){qn.a.unbind(e,t)}}const Zn=Object(z.g)({counter:1});function ea(e,t,n,a){e.style[t]=a instanceof Function?a(n):n+a,e.style.transition="none",getComputedStyle(e)[t]}function ta(e,t,n,a,i,o){e.style[t]=i instanceof Function?i(n):n+i,e.style.transition="none",getComputedStyle(e)[t]&&Zn.counter,e.style[t]=i instanceof Function?i(a):a+i,e.style.transition=t+" "+o+"s linear"}setInterval(()=>{Zn.counter++},500);var na=n(449),aa=n(450);const ia=()=>{Ie.map.addTimepoint(In.time,In.bpm,In.bpb,Ie.settings.editor.justify_grid_divisor)},oa=()=>{const e=In.selected;null!==e&&Ie.map.moveTimepoint(e,Ie.settings.editor.justify_find_nearest,Ie.settings.editor.justify_grid_divisor,In.time,In.bpm,In.bpb)},ra=()=>{const e=In.selected;if(null===e)return!1;const t=Ie.map.timepoints.get(e);return t?t.bpb!==In.bpb||t.bpm!==In.bpm||t.time!==In.time:(In.selected=null,!1)};var sa=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(dt.a,{item:!0,container:!0,wrap:"wrap",spacing:2},i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(bt.a,{fullWidth:!0,onClick:ia,disabled:null!==In.selected,color:"primary"},e("Add timepoint"))),i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(bt.a,{fullWidth:!0,onClick:oa,disabled:!ra(),color:"primary"},e("Apply changes"))),i.a.createElement(dt.a,{item:!0,container:!0,style:{marginTop:16}},i.a.createElement(na.a,{style:{marginLeft:"auto"},control:i.a.createElement(aa.a,{checked:In.muteticker,onChange:(e,t)=>In.muteticker=t}),label:e("Mute metronome"),labelPlacement:"start"})),i.a.createElement(dt.a,{item:!0,container:!0},i.a.createElement(na.a,{style:{marginLeft:"auto"},control:i.a.createElement(aa.a,{checked:In.autoswitchtp,onChange:(e,t)=>In.autoswitchtp=t}),label:e("Auto switch selected timepoint"),labelPlacement:"start"}))))};const la=Object(b.a)(e=>({root:{display:"flex",alignItems:"center",height:80,padding:10,transform:"translate(0, 0)","&>*":{flexGrow:1,height:"100%",margin:10,border:"solid 3px cornflowerblue",borderRadius:6,overflow:"hidden"},"& :first-child":{borderColor:"darkorange"},"&>*>*":{width:"100%",height:"100%",backgroundColor:"cornflowerblue",willChange:"opacity",opacity:0},"& :first-child>*":{backgroundColor:"darkorange"}}})),ca=M(()=>({tick:Ye.from(nt(Xn.timing_tick)).load(),tack:Ye.from(nt(Xn.timing_tack)).load()}));let ma=0;let ua=-1;function da(e){const t=it.position();if(!In.measuring&&In.autoswitchtp&&null!==In.selected&&it.playing&&!ra()){const[e]=Ie.map.findTimepoint(t);if(!e)return;e.id!==In.selected&&(In.selected=e.id)}const{time:n,bpm:a,bpb:i}=In,o=60/a,r=(t-n)/o,s=Math.floor(r),l=r-s,c=s%i,m=o/it.playbackrate;if(it.playing){let t=r-ua;if(t>.3&&(t=0),l-t<0)for(let a=0;a<e.length;a++)a===c?ta(e[a],"opacity",1,0,"",m/2):ea(e[a],"opacity",0,"");const n=(1-l)*m*1e3;n<50&&function(e,t){if(In.measuring||In.muteticker)return;const n=performance.now()+t;if(n<=ma)return;const a=ca();ma=n+100,new Ve(e?a.tick:a.tack).play(t/1e3)}(c===i-1,n)}else for(let u=0;u<e.length;u++)ea(e[u],"opacity",u===c?Math.max(0,2*(.5-l)):0,"");ua=r}var pa=()=>{const e=la(),t=Object(a.useRef)(null),n=Object(ot.a)(()=>In.bpb);return Object(a.useEffect)(()=>Kn(()=>{if(t.current){da(Array.from(t.current.children).map(e=>e.firstChild))}}),[]),Object(a.useEffect)(()=>Object(z.c)(()=>{const e=ca();e.tick.volume=Ie.settings.general.effect_volume,e.tack.volume=Ie.settings.general.effect_volume}),[]),i.a.createElement("div",{className:e.root,ref:t},R(n).map(e=>i.a.createElement("div",{key:e},i.a.createElement("div",null))))};function ha(e){const t=e.length/2|0;let n=0,a=0;for(;a+t<e.length;a++)n+=e[a+t]-e[a];const i=n/t/a,o=60/i;for(n=0,a=0;a<e.length;a++)n+=e[a]-a*i;return{bpm:o,offset:n/a}}const ga={taps:[],timeoutId:void 0},fa=e=>{const t=it.position();if(ga.taps.push(t),e(ga.taps.length),ga.taps.length>=5){const e=function(e){const t=ha(e);let n=!1;const a=60/t.bpm,i=[e[0]];for(let o=1;o<e.length;o++){const t=e[o],r=i[i.length-1],s=t-r;s<.3*a?n=!0:s>1.7*a?(i.push(r+a),o--,n=!0):i.push(t)}return n?ha(i):t}(ga.taps);In.bpm=e.bpm,In.time=e.offset}In.measuring=!0,clearTimeout(ga.timeoutId),ga.timeoutId=setTimeout(()=>{ga.taps.length=0,In.measuring=!1,e(0)},3e3)};var ba=()=>{const[e,t]=Object(a.useState)(0);Object(a.useEffect)(()=>Qn("t",()=>[fa(t)]),[]);const{t:n}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(bt.a,{fullWidth:!0,disableRipple:!0,onClick:()=>fa(t),disabled:!it.playing,title:n("Hotkey: {{ hotkey }}",{hotkey:"t"})},it.playing?e<=0?n("Click here or press 'T' to measure"):e<5?n("More {{ count }} times",{count:5-e}):n("Keep stable"):n("Play the music to start measure")))};var ya=Object(a.forwardRef)((e,t)=>{const{number:n,validator:o=(e=>/^-?([0-9]+(\.[0-9]+)?)$/.test(e)&&parseFloat(e)),numberDisplay:r=(e=>e.toString()),onNumberChange:s,onBlur:l,onChange:c,...m}=e,u=r(n),[d,p]=Object(a.useState)(u),[h,g]=Object(a.useState)(!0);h&&o(u)!==o(d)&&p(u);return i.a.createElement(yt.a,Object.assign({},m,{ref:t,value:d,onChange:e=>{p(e.target.value),c&&c(e);const t=o(e.target.value);"number"!==typeof t||isNaN(t)?g(!1):(g(!0),t!==n&&s&&s(e,t))},onBlur:e=>{l&&l(e),h||(p(u),g(!0))},color:h?"primary":"secondary"}))}),Ea=n(192),va=n.n(Ea),wa=n(193),Oa=n.n(wa),ja=n(451);const ka=e=>{In.time+=60*e/In.bpm};function _a(e){if(!/^-?([0-9]+:[0-9]{2}(.[0-9]+)?|[0-9]+(.[0-9]+)?)$/.test(e))return!1;const t=e.indexOf(":");return t<0?parseFloat(e):60*parseInt(e.substr(0,t))+parseFloat(e.substr(t+1))}var Na=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(dt.a,{item:!0,container:!0,spacing:2},i.a.createElement(dt.a,{item:!0,xs:12,sm:6},i.a.createElement(ya,{fullWidth:!0,label:e("Time"),numberDisplay:L,validator:_a,number:In.time,onNumberChange:(e,t)=>In.time=t})),i.a.createElement(dt.a,{item:!0,xs:12,container:!0,alignItems:"center"},i.a.createElement(dt.a,{item:!0},i.a.createElement(Dt.a,{onClick:()=>ka(-1),title:e("Backward one beat")},i.a.createElement(va.a,null)),i.a.createElement(Dt.a,{onClick:()=>ka(1),title:e("Forward one beat")},i.a.createElement(Oa.a,null))),i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(bt.a,{fullWidth:!0,onClick:()=>In.time=it.position()},e("Set to current player time")))),i.a.createElement(dt.a,{item:!0,xs:12,sm:6},i.a.createElement(ya,{fullWidth:!0,label:"BPM",inputProps:{type:"number",step:"0.001"},number:In.bpm,onNumberChange:(e,t)=>In.bpm=t})),i.a.createElement(dt.a,{item:!0,xs:12,sm:6},i.a.createElement(ya,{InputProps:{endAdornment:i.a.createElement(ja.a,{position:"end"},"/ 4")},fullWidth:!0,label:e("Meter"),inputProps:{type:"number",step:"1"},number:In.bpb,validator:e=>/^[0-9]+$/.test(e)&&parseInt(e),onNumberChange:(e,t)=>In.bpb=t}))))};const Sa=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>Ie.settings.editor.keep_pitch?i.a.createElement(dt.a,{item:!0},i.a.createElement(h.a,{p:1,fontWeight:"fontWeightLight",fontFamily:"sans-serif",fontStyle:"italic",textAlign:"center"},e('Some unstable delay may be caused by setting "Keep pitch"'))):null)};var xa=()=>i.a.createElement(dt.a,{item:!0,xs:12,sm:!0,container:!0,spacing:2,direction:"column"},i.a.createElement(dt.a,{item:!0},i.a.createElement(pa,null)),i.a.createElement(Sa,null),i.a.createElement(dt.a,{item:!0},i.a.createElement(ba,null)),i.a.createElement(Na,null),i.a.createElement(sa,null));const Ca=v()(e=>({timing:{width:"100%",maxWidth:1e3,margin:"32px auto"}}));var Ta=()=>{const e=Ca();return i.a.createElement(dt.a,{className:e.timing,container:!0,spacing:3},i.a.createElement(Jn,null),i.a.createElement(xa,null))},Pa=n(461),La=n(433),Ma=n(434),Ra=n(456),Aa=n(462),Fa=n(452),Da=n(389);const Ba=Object(b.a)(e=>({panel:{width:"100%",maxWidth:600,margin:"32px auto"}}));const Ha=e=>i.a.createElement(dt.a,{item:!0,container:!0,spacing:2,alignItems:"center"},i.a.createElement(dt.a,{component:Da.a,item:!0,style:{width:150}},i.a.createElement(Pn.a,null,e.label)),i.a.createElement(dt.a,{item:!0,xs:!0},e.children)),za=e=>i.a.createElement(dt.a,{component:Da.a,item:!0,container:!0,spacing:2,alignItems:"center"},i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(Pn.a,null,e.label)),i.a.createElement(dt.a,{item:!0},e.children)),Wa=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(i.a.Fragment,null,i.a.createElement(dt.a,{item:!0},i.a.createElement(Pn.a,{variant:"h6"},e("General"))),i.a.createElement(Ha,{label:e("Song volume")},i.a.createElement(Pa.a,{value:Ie.settings.general.song_volume,min:0,max:1,step:.01,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.general.song_volume=t})),i.a.createElement(Ha,{label:e("Effect volume")},i.a.createElement(Pa.a,{value:Ie.settings.general.effect_volume,min:0,max:1,step:.01,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.general.effect_volume=t})),i.a.createElement(Ha,{label:e("Background dim")},i.a.createElement(Pa.a,{value:Ie.settings.general.background_dim,min:0,max:1,step:.01,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.general.background_dim=t})),i.a.createElement(dt.a,{item:!0},i.a.createElement(La.a,{fullWidth:!0},i.a.createElement(Ma.a,null,e("Preferred language (some items maybe missing)")),i.a.createElement(Ra.a,{value:p.language,onChange:e=>p.changeLanguage(e.target.value)},i.a.createElement(Aa.a,{value:"en"},"English"),i.a.createElement(Aa.a,{value:"zh"},"\u7b80\u4f53\u4e2d\u6587"),i.a.createElement(Aa.a,{value:"ja"},"\u65e5\u672c\u8a9e"))))))},Ia=(e,t)=>{Ie.settings.editor.keep_pitch=t,Yt(t?p.t("This may cause unstable delay of song.")+" "+p.t("Please reload the music to activate"):p.t("Please reload the music to activate"),"warning")},$a=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>{return i.a.createElement(i.a.Fragment,null,i.a.createElement(dt.a,{item:!0},i.a.createElement(Pn.a,{variant:"h6"},e("Editor"))),i.a.createElement(dt.a,{item:!0,container:!0,spacing:2},i.a.createElement(dt.a,{component:Da.a,item:!0,xs:12},i.a.createElement(Pn.a,null,e("Auto save interval (minutes, 0 to disable)")," \xa0\xa0",e("Last save: {{ time }}",{time:Ie.lastSave?(t=Ie.lastSave,`${(t.getHours()+100).toString().substr(1)}:${(t.getMinutes()+100).toString().substr(1)}:${(t.getSeconds()+100).toString().substr(1)}`):e("Never")}))),i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(Pa.a,{value:Ie.settings.editor.autosave_interval,min:0,max:10,step:.5,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.editor.autosave_interval=t}))),i.a.createElement(za,{label:e("Keep pitch when changing playback rate")},i.a.createElement(aa.a,{checked:Ie.settings.editor.keep_pitch,onChange:Ia})),i.a.createElement(dt.a,{item:!0},i.a.createElement(La.a,{fullWidth:!0},i.a.createElement(Ma.a,null,e("When changes applied, try to keep notes at")),i.a.createElement(Ra.a,{value:Ie.settings.editor.justify_find_nearest?1:0,onChange:e=>Ie.settings.editor.justify_find_nearest=!!e.target.value},i.a.createElement(Aa.a,{value:1},e("Previous time")),i.a.createElement(Aa.a,{value:0},e("Previous beat"))))),i.a.createElement(dt.a,{item:!0},i.a.createElement(La.a,{fullWidth:!0},i.a.createElement(Ma.a,null,e("Grid divisor (of a quarter) to justify notes when justifying timepoint")),i.a.createElement(Ra.a,{value:Ie.settings.editor.justify_grid_divisor,onChange:e=>Ie.settings.editor.justify_grid_divisor=e.target.value},i.a.createElement(Aa.a,{value:1},"1 / 1"),i.a.createElement(Aa.a,{value:2},"1 / 2"),i.a.createElement(Aa.a,{value:3},"1 / 3"),i.a.createElement(Aa.a,{value:4},"1 / 4"),i.a.createElement(Aa.a,{value:6},"1 / 6"),i.a.createElement(Aa.a,{value:8},"1 / 8"),i.a.createElement(Aa.a,{value:16},"1 / 16"),i.a.createElement(Aa.a,{value:48},"1 / 48")))),i.a.createElement(za,{label:e("Show cursor information in mapping")},i.a.createElement(aa.a,{checked:Ie.settings.editor.show_info_window,onChange:(e,t)=>Ie.settings.editor.show_info_window=t})),i.a.createElement(za,{label:e("Show warning for same position notes")},i.a.createElement(aa.a,{checked:Ie.settings.editor.warn_for_same_pos_notes,onChange:(e,t)=>Ie.settings.editor.warn_for_same_pos_notes=t})));var t})};let Ua;const Ya=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(i.a.Fragment,null,i.a.createElement(dt.a,{item:!0},i.a.createElement(Pn.a,{variant:"h6"},e("Game"))),i.a.createElement(dt.a,{item:!0},i.a.createElement(La.a,{fullWidth:!0},i.a.createElement(Ma.a,null,e("Skin")),i.a.createElement(Ra.a,{value:Ie.settings.game.skin,onChange:e=>Ie.settings.game.skin=e.target.value},i.a.createElement(Aa.a,{value:"default"},"\u9ed8\u8ba4"),i.a.createElement(Aa.a,{value:"skin04"},"\u76ae\u80a45"),i.a.createElement(Aa.a,{value:"persona"},"\u5973\u795e\u5f02\u95fb\u5f55persona[\u4e0d\u53ef\u7528]"),i.a.createElement(Aa.a,{value:"cafe"},"\u8bf7\u95ee\u60a8\u4eca\u5929\u8981\u6765\u70b9\u5154\u5b50\u5417\uff1f"),i.a.createElement(Aa.a,{value:"miku"},"\u521d\u97f3\u672a\u6765"),i.a.createElement(Aa.a,{value:"maid"},"Re\uff1a\u4ece\u96f6\u5f00\u59cb\u7684\u5f02\u4e16\u754c\u751f\u6d3b"),i.a.createElement(Aa.a,{value:"april_fool"},"\u611a\u4eba\u8282"),i.a.createElement(Aa.a,{value:"coin"},"\u67d0\u79d1\u5b66\u7684\u8d85\u7535\u78c1\u70aeT")))),i.a.createElement(dt.a,{item:!0,container:!0,spacing:2},i.a.createElement(dt.a,{component:Da.a,item:!0,xs:12},i.a.createElement(Pn.a,null,e("Judge offset (ms, smaller means you have to tap earlier)"))),i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(Pa.a,{value:Ie.settings.game.judge_offset,min:-1e3,max:1e3,step:1,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.game.judge_offset=t})),i.a.createElement(dt.a,{item:!0,style:{width:72}},i.a.createElement(ya,{inputProps:{type:"number",step:"1",max:"1000",min:"-1000"},number:Ie.settings.game.judge_offset,validator:e=>/^-?[0-9]+$/.test(e)&&(Ua=parseInt(e),Ua<=1e3&&Ua>=-1e3&&Ua),onNumberChange:(e,t)=>Ie.settings.game.judge_offset=t}))),i.a.createElement(dt.a,{item:!0,container:!0,spacing:2},i.a.createElement(dt.a,{component:Da.a,item:!0,xs:12},i.a.createElement(Pn.a,null,e("Visual offset (ms, smaller means notes fall earlier)"))),i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(Pa.a,{value:Ie.settings.game.visual_offset,min:-1e3,max:1e3,step:1,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.game.visual_offset=t})),i.a.createElement(dt.a,{item:!0,style:{width:72}},i.a.createElement(ya,{inputProps:{type:"number",step:"1",max:"1000",min:"-1000"},number:Ie.settings.game.visual_offset,validator:e=>/^-?[0-9]+$/.test(e)&&(Ua=parseInt(e),Ua<=1e3&&Ua>=-1e3&&Ua),onNumberChange:(e,t)=>Ie.settings.game.visual_offset=t}))),i.a.createElement(dt.a,{item:!0,container:!0,spacing:2},i.a.createElement(dt.a,{component:Da.a,item:!0,style:{width:150}},i.a.createElement(Pn.a,null,e("Fall speed"))),i.a.createElement(dt.a,{item:!0,xs:!0},i.a.createElement(Pa.a,{value:Ie.settings.game.speed,min:1,max:11,step:.1,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.game.speed=t})),i.a.createElement(dt.a,{item:!0,style:{width:72}},i.a.createElement(ya,{inputProps:{type:"number",step:"0.1",max:"11",min:"1"},number:Ie.settings.game.speed,validator:e=>/^[0-9]+(.[0-9]?)?$/.test(e)&&(Ua=parseFloat(e),Ua<=11&&Ua>=1&&Ua),onNumberChange:(e,t)=>Ie.settings.game.speed=t}))),i.a.createElement(Ha,{label:e("Resolution")},i.a.createElement(Pa.a,{value:Ie.settings.game.resolution,min:.2,max:4,step:.05,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.game.resolution=t})),i.a.createElement(Ha,{label:e("Slide bar opacity")},i.a.createElement(Pa.a,{value:Ie.settings.game.bar_opaciry,min:0,max:1,step:.01,valueLabelDisplay:"auto",onChange:(e,t)=>Ie.settings.game.bar_opaciry=t})),i.a.createElement(za,{label:e("Show simultaneous line")},i.a.createElement(aa.a,{checked:Ie.settings.game.show_sim_line,onChange:(e,t)=>Ie.settings.game.show_sim_line=t})),i.a.createElement(za,{label:e("Lane tap effect")},i.a.createElement(aa.a,{checked:Ie.settings.game.lane_effect,onChange:(e,t)=>Ie.settings.game.lane_effect=t})),i.a.createElement(za,{label:e("Mirror")},i.a.createElement(aa.a,{checked:Ie.settings.game.mirror,onChange:(e,t)=>Ie.settings.game.mirror=t})),i.a.createElement(za,{label:e("Rhythm visual assist")},i.a.createElement(aa.a,{checked:Ie.settings.game.beat_note,onChange:(e,t)=>Ie.settings.game.beat_note=t}))))};var Va,Ja,Ga,Xa,qa,Ka,Qa,Za=()=>{const e=Ba();return i.a.createElement(dt.a,{className:e.panel,container:!0,direction:"column",spacing:4},i.a.createElement(Wa,null),i.a.createElement(Fa.a,{style:{margin:"32px -24px",width:"30%"}}),i.a.createElement($a,null),i.a.createElement(Fa.a,{style:{margin:"32px -24px",width:"30%"}}),i.a.createElement(Ya,null))};const ei=e=>`${e.timepoint}:${e.offset}:${e.lane}`;const ti=new(Va=class{get viewOffset(){return 100/this.timeHeightFactor}get viewduration(){return it.duration-this.viewOffset}get paddedDuration(){return 1.2*it.duration}get samePosNotes(){const e=new Set;for(const n of Ie.map.slidelist){let t=_(Ie.map.notes.get(n.notes[0]));for(let a=1;a<n.notes.length;a++){const i=_(Ie.map.notes.get(n.notes[a]));t.timepoint===i.timepoint&&t.offset===i.offset&&(e.add(t.id),e.add(i.id)),t=i}}const t=new Set;for(const n of Ie.map.notelist){const a=ei(n);t.has(a)&&e.add(n.id),t.add(a)}return e}get noteListOrdered(){return Ie.map.notelist.slice().sort((e,t)=>e.realtimecache-t.realtimecache)}constructor(){Object(w.a)(this,"_viewposition",Ja,this),this.getViewposition=()=>this.tracking?it.position()-this.viewOffset:this._viewposition,this.setViewposition=e=>{const t=this.viewOffset;e<-t&&(e=-t),e>it.duration-t&&(e=it.duration-.05-t),this.tracking?it.seek(e+t):this._viewposition=e},Object(w.a)(this,"tracking",Ga,this),Object(w.a)(this,"timeHeightFactor",Xa,this),Object(w.a)(this,"division",qa,this),Object(w.a)(this,"tool",Ka,this),Object(w.a)(this,"mirror",Qa,this),Object(z.h)(()=>this.tracking,e=>{const t=100/this.timeHeightFactor;e||(this._viewposition=it.position()-t)})}},Ja=Object(O.a)(Va.prototype,"_viewposition",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Object(O.a)(Va.prototype,"viewOffset",[z.d],Object.getOwnPropertyDescriptor(Va.prototype,"viewOffset"),Va.prototype),Object(O.a)(Va.prototype,"viewduration",[z.d],Object.getOwnPropertyDescriptor(Va.prototype,"viewduration"),Va.prototype),Ga=Object(O.a)(Va.prototype,"tracking",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Xa=Object(O.a)(Va.prototype,"timeHeightFactor",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 400}}),qa=Object(O.a)(Va.prototype,"division",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ka=Object(O.a)(Va.prototype,"tool",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"none"}}),Qa=Object(O.a)(Va.prototype,"mirror",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Object(O.a)(Va.prototype,"paddedDuration",[z.d],Object.getOwnPropertyDescriptor(Va.prototype,"paddedDuration"),Va.prototype),Object(O.a)(Va.prototype,"samePosNotes",[z.d],Object.getOwnPropertyDescriptor(Va.prototype,"samePosNotes"),Va.prototype),Object(O.a)(Va.prototype,"noteListOrdered",[z.d],Object.getOwnPropertyDescriptor(Va.prototype,"noteListOrdered"),Va.prototype),Va);function ni(){const e=Ie.map.timepointlist,t=[];let n=0;for(let a=0;a<e.length;a++){const i=e[a];n=(a<e.length-1?e[a+1].time:it.duration)-.01;let o=1;for(;;){const e=i.time+48*i.ticktimecache*o;if(e>=n)break;const r=1+(o/i.bpb|0),s=o%i.bpb+1;t.push({time:e,name:`${a+1}:${r}:${s}`}),o++}}return t}var ai=n(466),ii=n(458),oi=n(195),ri=n.n(oi),si=n(196),li=n.n(si),ci=n(197),mi=n.n(ci),ui=n(465);const di=Object(b.a)(e=>({tools:{position:"relative",flexGrow:.5,flexShrink:1.5,maxWidth:"calc(40% - 100px)",overflowX:"hidden",overflowY:"auto","-webkit-overflow-scrolling":"touch","&>*":{maxWidth:300,position:"absolute",right:0,top:30}},toolimg:{width:80}})),pi=()=>{let e=1.414*ti.timeHeightFactor;e>1580&&(e=1600),ti.timeHeightFactor=e},hi=()=>{let e=ti.timeHeightFactor/1.414;e<120&&(e=100),ti.timeHeightFactor=e},gi=()=>{const e=di(),{t:t}=Object(l.b)();return Object(a.useEffect)(()=>Qn("1",()=>ti.tool="none"),[]),Object(a.useEffect)(()=>Qn("2",()=>ti.tool="single"),[]),Object(a.useEffect)(()=>Qn("3",()=>ti.tool="slide"),[]),Object(a.useEffect)(()=>Qn("4",()=>ti.tool="delete"),[]),Object(ot.a)(()=>i.a.createElement(dt.a,{item:!0},i.a.createElement(h.a,{display:"block",my:2,component:Da.a},i.a.createElement(dt.a,{container:!0,alignItems:"center",spacing:2},i.a.createElement(dt.a,{item:!0},t("Tool")),i.a.createElement(dt.a,{item:!0},i.a.createElement(ui.a,{placement:"right",title:i.a.createElement(Pn.a,{variant:"body2"},t("Double click to switch flick")," ",i.a.createElement("br",null),t("Right click to delete note(s)")," ",i.a.createElement("br",null),t("Click the slide bar to add mid note")," ",i.a.createElement("br",null),t("Hold ctrl and drag to multi-select & copy notes"))},i.a.createElement(ri.a,{fontSize:"small"}))))),i.a.createElement(ai.a,{value:ti.tool,onChange:(e,t)=>ti.tool=t},i.a.createElement(na.a,{value:"none",control:i.a.createElement(ii.a,null),label:t("None"),title:t("Hotkey: {{ hotkey }}",{hotkey:"1"})}),i.a.createElement(na.a,{value:"single",control:i.a.createElement(ii.a,null),label:i.a.createElement("img",{className:e.toolimg,src:Xn.note_normal,alt:"Single / Flick"}),title:t("Hotkey: {{ hotkey }}",{hotkey:"2"})}),i.a.createElement(na.a,{value:"slide",control:i.a.createElement(ii.a,null),label:i.a.createElement("img",{className:e.toolimg,src:Xn.note_long,alt:"Slide"}),title:t("Hotkey: {{ hotkey }}",{hotkey:"3"})}),i.a.createElement(na.a,{value:"delete",control:i.a.createElement(ii.a,null),label:t("Delete"),title:t("Hotkey: {{ hotkey }}",{hotkey:"4 / Right click"})}))))},fi=()=>{const{t:e}=Object(l.b)();return Object(ot.a)(()=>i.a.createElement(dt.a,{item:!0},i.a.createElement(La.a,{fullWidth:!0},i.a.createElement(Ma.a,null,e("Grid divisor (of a quarter note)")),i.a.createElement(Ra.a,{fullWidth:!0,value:ti.division,onChange:e=>ti.division=e.target.value},i.a.createElement(Aa.a,{value:1},"1 / 1"),i.a.createElement(Aa.a,{value:2},"1 / 2"),i.a.createElement(Aa.a,{value:3},"1 / 3"),i.a.createElement(Aa.a,{value:4},"1 / 4"),i.a.createElement(Aa.a,{value:6},"1 / 6"),i.a.createElement(Aa.a,{value:8},"1 / 8"),i.a.createElement(Aa.a,{value:16},"1 / 16"),i.a.createElement(Aa.a,{value:48},"1 / 48")))))},bi=()=>{const{t:e}=Object(l.b)();return Object(a.useEffect)(()=>Qn("+,=",pi),[]),Object(a.useEffect)(()=>Qn("-,_",hi),[]),Object(a.useEffect)(()=>{const e=document.getElementById("root"),t=e=>{e.ctrlKey&&(e.stopPropagation(),e.preventDefault(),e.deltaY<0?pi():hi())};return null===e||void 0===e||e.addEventListener("wheel",t),()=>null===e||void 0===e?void 0:e.removeEventListener("wheel",t)},[]),Object(ot.a)(()=>i.a.createElement(dt.a,{item:!0,container:!0,spacing:2},i.a.createElement(dt.a,{item:!0},i.a.createElement(Dt.a,{onClick:pi,disabled:ti.timeHeightFactor>1580,title:e("Hotkey: {{ hotkey }}",{hotkey:"+ / ctrl + wheel"})},i.a.createElement(li.a,null))),i.a.createElement(dt.a,{item:!0},i.a.createElement(Dt.a,{onClick:hi,disabled:ti.timeHeightFactor<120,title:e("Hotkey: {{ hotkey }}",{hotkey:"- / ctrl + wheel"})},i.a.createElement(mi.a,null)))))},yi=()=>{const{t:e}=Object(l.b)();return Object(a.useEffect)(()=>Qn("f",()=>ti.tracking=!ti.tracking),[]),Object(a.useEffect)(()=>Qn("tab",e=>{ti.mirror=!ti.mirror,e.stopPropagation(),e.preventDefault()}),[]),Object(ot.a)(()=>i.a.createElement(dt.a,{item:!0,container:!0,spacing:2},i.a.createElement(dt.a,{item:!0},i.a.createElement(na.a,{label:e("Follow"),title:e("Hotkey: {{ hotkey }}",{hotkey:"f"}),control:i.a.createElement(aa.a,{checked:ti.tracking,onChange:(e,t)=>ti.tracking=t})})),i.a.createElement(dt.a,{item:!0},i.a.createElement(na.a,{label:e("Mirror"),title:e("Hotkey: {{ hotkey }}",{hotkey:"tab"}),control:i.a.createElement(aa.a,{checked:ti.mirror,onChange:(e,t)=>ti.mirror=t})}))))};var Ei=()=>{const e=di();return i.a.createElement(h.a,{className:e.tools},i.a.createElement(dt.a,{container:!0,spacing:4,direction:"column"},i.a.createElement(gi,null),i.a.createElement(fi,null),i.a.createElement(bi,null),i.a.createElement(yi,null)))};const vi=Object(b.a)(e=>({track:{position:"relative",flexGrow:1,maxWidth:600},panel:{width:"100%",position:"absolute",bottom:0,willChange:"transform"},layer:{width:"100%",height:"100%",position:"absolute",pointerEvents:"none"}})),wi=Object(b.a)(e=>({note:{transform:"translateY(50%) scale(1.2)",width:"10%",position:"absolute",pointerEvents:"auto",minHeight:"10px"},noevent:{pointerEvents:"none"},slidebar:{background:"greenyellow",opacity:.2,width:"10%",position:"absolute",pointerEvents:"auto"},selection:{position:"absolute",pointerEvents:"none",background:"gray",opacity:.3,border:"2px solid rgba(80, 182, 255, 0.8)"}}));var Oi,ji,ki,_i,Ni,Si,xi,Ci,Ti,Pi,Li,Mi,Ri;const Ai=new(Oi=class{get pointerTime(){const e=this.panelRef.current;if(!e)return 0;return(e.getBoundingClientRect().bottom-this.pointerClientY)/ti.timeHeightFactor}get pointerLeftPercent(){const e=this.panelRef.current;if(!e)return-1;const t=e.getBoundingClientRect();return ti.mirror?(t.right-this.pointerClientX)/t.width*100:(this.pointerClientX-t.left)/t.width*100}get pointerLane(){return this.laneFromLeftPercent(this.pointerLeftPercent)}get pointerBeat(){return Ie.map.calcNearestPosition(this.pointerTime,ti.division)}get draggingSelected(){const e=Ie.map.notes.get(this.draggingNote);return!!e&&this.selectedNotes.has(e.id)}constructor(){Object(w.a)(this,"pointerClientX",ji,this),Object(w.a)(this,"pointerClientY",ki,this),Object(w.a)(this,"panelRef",_i,this),this.laneFromLeftPercent=e=>{const t=e-15;return t<0?-1:t>=70?-1:t/10|0},Object(w.a)(this,"slideNote1Beat",Ni,this),Object(w.a)(this,"slideNote1Lane",Si,this),Object(w.a)(this,"preventClick",xi,this),Object(w.a)(this,"draggingNote",Ci,this),Object(w.a)(this,"selecting",Ti,this),Object(w.a)(this,"selectingStartTime",Pi,this),Object(w.a)(this,"selectingStartLeft",Li,this),Object(w.a)(this,"selectingNotes",Mi,this),Object(w.a)(this,"selectedNotes",Ri,this),this.getSelectedNotes=()=>{const e=new Set;for(const t of this.selectedNotes){const n=Ie.map.notes.get(t);n&&e.add(n)}for(const t of this.selectingNotes){const n=Ie.map.notes.get(t);n&&e.add(n)}return P(e)},Object(z.h)(()=>ti.tool,e=>{this.slideNote1Beat=void 0})}},ji=Object(O.a)(Oi.prototype,"pointerClientX",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ki=Object(O.a)(Oi.prototype,"pointerClientY",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_i=Object(O.a)(Oi.prototype,"panelRef",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{current:null}}}),Object(O.a)(Oi.prototype,"pointerTime",[z.d],Object.getOwnPropertyDescriptor(Oi.prototype,"pointerTime"),Oi.prototype),Object(O.a)(Oi.prototype,"pointerLeftPercent",[z.d],Object.getOwnPropertyDescriptor(Oi.prototype,"pointerLeftPercent"),Oi.prototype),Object(O.a)(Oi.prototype,"pointerLane",[z.d],Object.getOwnPropertyDescriptor(Oi.prototype,"pointerLane"),Oi.prototype),Object(O.a)(Oi.prototype,"pointerBeat",[z.d],Object.getOwnPropertyDescriptor(Oi.prototype,"pointerBeat"),Oi.prototype),Ni=Object(O.a)(Oi.prototype,"slideNote1Beat",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Si=Object(O.a)(Oi.prototype,"slideNote1Lane",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),xi=Object(O.a)(Oi.prototype,"preventClick",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ci=Object(O.a)(Oi.prototype,"draggingNote",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ti=Object(O.a)(Oi.prototype,"selecting",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pi=Object(O.a)(Oi.prototype,"selectingStartTime",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Li=Object(O.a)(Oi.prototype,"selectingStartLeft",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mi=Object(O.a)(Oi.prototype,"selectingNotes",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ri=Object(O.a)(Oi.prototype,"selectedNotes",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Set}}),Object(O.a)(Oi.prototype,"draggingSelected",[z.d],Object.getOwnPropertyDescriptor(Oi.prototype,"draggingSelected"),Oi.prototype),Oi);function Fi(){const e=Object(a.useRef)(null);return Object(a.useEffect)(()=>Object(z.c)(()=>{e.current&&(ti.mirror?e.current.style.transform="scaleX(-1)":e.current.style.transform="none")}),[]),e}const Di=e=>{var t;return i.a.createElement("svg",Object.assign({viewBox:"0 0 500 500"},e),i.a.createElement("g",{stroke:e.color||(null===(t=e.style)||void 0===t?void 0:t.color),strokeWidth:"20",fill:"none"},i.a.createElement("path",{d:"M 0 250 H 500"}),i.a.createElement("path",{d:"M 250 0 V 500"})))},Bi=e=>{var t;return i.a.createElement("svg",Object.assign({viewBox:"0 0 500 200"},e),i.a.createElement("g",{stroke:e.color||(null===(t=e.style)||void 0===t?void 0:t.color),strokeWidth:"40",fill:"none"},i.a.createElement("path",{d:"M 0 0 H 500 V 200 H 0 V 0"})))},Hi=(e,t)=>({bottom:e*ti.timeHeightFactor+"px",left:10*t+15+"%"}),zi=()=>{const e=wi(),t=Object(ot.a)(()=>{if(Ai.selecting)return;if(Ai.pointerLane<0)return;const e=Ai.pointerBeat;if(!e)return;let t="#afafaf";switch(ti.tool){case"single":t="#0088ff";break;case"slide":t="#00ff88";break;case"delete":t="#ff4444"}return{...Hi(e.realtime,Ai.pointerLane),color:t}});return t?i.a.createElement(Di,{className:e.note+" "+e.noevent,style:t}):null},Wi=()=>{const e=wi(),t=Object(ot.a)(()=>{if(!Ai.slideNote1Beat)return;const e=Ai.slideNote1Beat.timepoint.time+Ai.slideNote1Beat.timepoint.ticktimecache*Ai.slideNote1Beat.offset;return{...Hi(e,Ai.slideNote1Lane),color:"#00ff88"}});return t?i.a.createElement(Bi,{className:e.note+" "+e.noevent,style:t}):null},Ii=()=>{const e=wi(),t=Object(ot.a)(()=>{if(Ai.draggingNote<0)return;if(Ai.pointerLane<0)return;const e=Ie.map.notes.get(Ai.draggingNote);if(!e)return;const t=Ai.pointerBeat;if(!t)return;const n=t.realtime;return n!==e.realtimecache||Ai.pointerLane!==e.lane?{from:{...Hi(e.realtimecache,e.lane),color:"#a0a0a0"},to:{...Hi(n,Ai.pointerLane),color:"#e0e0e0"}}:void 0});return t?i.a.createElement(i.a.Fragment,null,i.a.createElement(Bi,{className:e.note+" "+e.noevent,style:t.from}),i.a.createElement(Bi,{className:e.note+" "+e.noevent,style:t.to})):null},$i=()=>{const e=wi(),t=Object(ot.a)(()=>{const t=e.note+" "+e.noevent,n=new Map;for(const e of Ai.getSelectedNotes())n.set(e.id,{key:e.id,style:{...Hi(e.realtimecache,e.lane),color:"rgba(102, 183, 255, 0.8)"},className:t});return T(n).map(e=>e[1])});return t.length<=0?null:i.a.createElement(i.a.Fragment,null,t.map(e=>i.a.createElement(Bi,e)))},Ui=()=>{const e=wi(),t=Object(ot.a)(()=>{if(!Ai.selecting)return;const e=Ai.selectingStartLeft,t=Ai.pointerLeftPercent,n=Ai.selectingStartTime,a=Ai.pointerTime;return{left:Math.min(e,t)+"%",width:Math.abs(e-t)+"%",bottom:Math.min(n,a)*ti.timeHeightFactor+"px",height:Math.abs(n-a)*ti.timeHeightFactor+"px"}});return t?i.a.createElement("div",{className:e.selection,style:t}):null};var Yi=()=>{const e=vi(),t=Fi();return i.a.createElement("div",{className:e.layer,ref:t},i.a.createElement(Wi,null),i.a.createElement($i,null),i.a.createElement(Ii,null),i.a.createElement(Ui,null),i.a.createElement(zi,null))};const Vi=Object(b.a)(e=>({vertline:{borderLeft:"1.2px solid lightgray",height:"100%",position:"absolute",pointerEvents:"none"},beatline1:{position:"absolute",textAlign:"right",width:"80%",right:"5%",borderBottom:"1.2px lightgray solid"},subline:{position:"absolute",width:"70%",left:"15%"},beatline2:{borderBottom:"1.2px solid gray"},beatline3:{borderBottom:"1.2px solid firebrick"},beatline4:{borderBottom:"1.2px solid darkslateblue"},time:{position:"absolute",left:0},bpm:{position:"absolute",right:0},timepoint:{position:"absolute",color:"aquamarine",width:"95%",borderBottom:"1.2px aquamarine solid",height:"1.5em"}})),Ji=e=>({bottom:ti.timeHeightFactor*e+"px"}),Gi=R(15,90,10),Xi=()=>{const e=Vi();return Object(ot.a)(()=>i.a.createElement(i.a.Fragment,null,i.a.createElement(i.a.Fragment,null,Gi.map(t=>i.a.createElement("div",{key:t,className:e.vertline,style:{left:t+"%"}}))),i.a.createElement(i.a.Fragment,null,R(0,it.duration,2).map(t=>i.a.createElement("div",{key:t,className:e.time,style:Ji(t)},L(t))))))},qi=()=>{const e=Vi();return Object(ot.a)(()=>i.a.createElement(i.a.Fragment,null,i.a.createElement(i.a.Fragment,null,ni().map(({time:t,name:n},a)=>i.a.createElement("div",{key:a,className:e.beatline1,style:Ji(t)},n))),i.a.createElement(i.a.Fragment,null,ti.division%2===0&&function(){const e=Ie.map.timepointlist,t=[];let n=0;for(let a=0;a<e.length;a++){const i=e[a];n=(a<e.length-1?e[a+1].time:it.duration)-.01;let o=0;const r=24*i.ticktimecache;for(;;){const e=i.time+48*i.ticktimecache*o+r;if(e>=n)break;t.push(e),o++}}return t}().map((t,n)=>i.a.createElement("div",{key:n,className:e.subline+" "+e.beatline2,style:Ji(t)}))),i.a.createElement(i.a.Fragment,null,ti.division%3===0&&function(){const e=Ie.map.timepointlist,t=[];let n=0;for(let a=0;a<e.length;a++){const i=e[a];n=(a<e.length-1?e[a+1].time:it.duration)-.01;let o=1;for(;;){const e=i.time+16*i.ticktimecache*o;if(e>=n)break;t.push(e),o++,o%3===0&&o++}}return t}().map((t,n)=>i.a.createElement("div",{key:n,className:e.subline+" "+e.beatline3,style:Ji(t)}))),i.a.createElement(i.a.Fragment,null,ti.division%4===0&&function(){const e=Ie.map.timepointlist,t=[];let n=0;for(let a=0;a<e.length;a++){const i=e[a];n=(a<e.length-1?e[a+1].time:it.duration)-.01;let o=.5;for(;;){const e=i.time+24*i.ticktimecache*o;if(e>=n)break;t.push(e),o++}}return t}().map((t,n)=>i.a.createElement("div",{key:n,className:e.subline+" "+e.beatline4,style:Ji(t)})))))},Ki=()=>{const e=Vi();return Object(ot.a)(()=>i.a.createElement(i.a.Fragment,null,Ie.map.timepointlist.map(t=>i.a.createElement("div",{className:e.timepoint,key:t.id,style:Ji(t.time)},i.a.createElement("div",{className:e.time},L(t.time)),i.a.createElement("div",{className:e.bpm},t.bpm)))))};var Qi=()=>{const e=vi();return i.a.createElement("div",{className:e.layer},i.a.createElement(Xi,null),i.a.createElement(qi,null),i.a.createElement(Ki,null))};let Zi=-1;const eo=Object(z.b)(e=>Object(z.b)(t=>{t.stopPropagation(),t.preventDefault();const n=_(Ie.map.notes.get(e));if(Zi<0)if("buttons"in t){if(!(3&t.buttons))return;Zi=t.button}else Zi=t.changedTouches[0].identifier;Ai.draggingNote=e,t.ctrlKey||Ai.selectedNotes.has(n.id)||Ai.selectedNotes.clear(),Ai.slideNote1Beat=void 0})),to=Object(z.b)(e=>{if("buttons"in e){if(e.button!==Zi)return}else if(e.changedTouches[0].identifier!==Zi)return;if(Zi=-1,Ai.draggingNote>=0){const t=_(Ie.map.notes.get(Ai.draggingNote)),n=Ai.draggingSelected;if(Ai.draggingNote=-1,!Ai.pointerBeat)return;if(Ai.pointerLane<0)return;const a=Ai.pointerBeat.realtime-t.realtimecache,i=Ai.pointerLane-t.lane;if(!a&&!i)return;const o=new Set,r=e.ctrlKey;if(r)for(const e of Ie.map.notelist)o.add(e.id);n?r?Ie.map.copyMany(Ai.getSelectedNotes(),a,0,it.duration,i,ti.division):Ie.map.moveMany(Ai.getSelectedNotes(),a,0,it.duration,i,ti.division):r?Ie.map.copyMany([t],a,0,it.duration,i,ti.division):Ie.map.moveMany([t],a,0,it.duration,i,ti.division),setTimeout(Object(z.b)(()=>{if(r&&Ie.map.notes.size!==o.size){Ai.selectedNotes.clear();for(const e of Ie.map.notelist)o.has(e.id)||Ai.selectedNotes.add(e.id)}})),Ai.preventClick++,setTimeout(()=>Ai.preventClick--,50)}});window.addEventListener("mouseup",to),window.addEventListener("touchend",to);const no=e=>{Ai.selectedNotes.has(e.id)?Ie.map.removeNotes(Ai.getSelectedNotes()):Ie.map.removeNotes([e])},ao=({note:e})=>{const t=wi(),n=Object(a.useMemo)(()=>eo(e.id),[e.id]),o=Object(a.useMemo)(()=>{return t=e.id,e=>{if(e.stopPropagation(),e.preventDefault(),Ai.preventClick)return;const n=_(Ie.map.notes.get(t));no(n)};var t},[e.id]),r=Object(a.useMemo)(()=>{return t=e.id,e=>{if(e.stopPropagation(),e.preventDefault(),Ai.preventClick)return;const n=_(Ie.map.notes.get(t));if("slide"===n.type){const e=_(Ie.map.slides.get(n.slide));n.id===e.notes[e.notes.length-1]&&Ie.map.toggleFlickend(e.id)}else Ie.map.toggleFlick(n)};var t},[e.id]),s=Object(a.useMemo)(()=>{return t=e.id,e=>{e.stopPropagation(),e.preventDefault();const n=_(Ie.map.notes.get(t));if(e.ctrlKey)Ai.selectedNotes.has(n.id)?Ai.selectedNotes.delete(n.id):Ai.selectedNotes.add(n.id);else switch(ti.tool){case"delete":no(n)}};var t},[e.id]),l=Object(ot.a)(()=>{const a=10*e.lane+15+"%",i=ti.timeHeightFactor*e.realtimecache+"px";let l;if(!Ie.map.notes.get(e.id))return{};switch(e.type){case"single":l=Xn.note_normal;break;case"flick":l=Xn.note_flick;break;case"slide":const t=_(Ie.map.slides.get(e.slide));l=e.id===t.notes[0]?Xn.note_long:e.id===t.notes[t.notes.length-1]?t.flickend?Xn.note_flick:Xn.note_long:Xn.note_slide_among;break;default:k()}return{style:{left:a,bottom:i},src:l,draggable:!1,className:t.note,onMouseDown:n,onContextMenu:o,onDoubleClick:r,onClick:s}});return i.a.createElement("img",Object.assign({alt:""},l))};var io=()=>{const e=vi(),t=Fi();return Object(ot.a)(()=>i.a.createElement("div",{className:e.layer,ref:t},Ie.map.notelist.map(e=>i.a.createElement(ao,{key:e.id,note:e}))))};const oo=Object(b.a)(e=>({progress:{position:"absolute",width:"80%",left:"10%",borderBottom:"2px solid red",bottom:0,willChange:"transform",opacity:.7}})),ro=(e,t)=>ti.timeHeightFactor*(t-e),so=e=>`translateY(${e}px)`;var lo=()=>{const e=oo(),t=Object(a.useRef)(null);return Object(a.useEffect)(()=>Object(z.c)(()=>{if(t.current){const e=it.position(),n=ti.getViewposition(),a=ro(e,n),i=ro(it.duration,n);it.playing&&!ti.tracking?ta(t.current,"transform",a,i,so,it.remaintime()):ea(t.current,"transform",a,so)}}),[]),i.a.createElement("div",{className:e.progress,ref:t})};const co=Object(b.a)(e=>({root:{position:"absolute",width:0,left:0,height:0,bottom:0,color:"lightgray",userSelect:"text"},window:{position:"absolute",width:100,height:84,right:"calc(12px + 3vw)",bottom:48,padding:12,background:"rgba(127, 127, 127, 0.15)",borderRadius:4,textAlign:"right"}}));var mo=()=>{const e=co(),t=Object(ot.a)(()=>{const e=Ai.pointerBeat;if(!e||e.offset<0)return;const t=e.timepoint.bpb,n=e.offset/48|0;let a=e.offset%48;for(;a<0;)a+=48;const i=function(e,t){if(t|=0,(e|=0)<0||t<=0)throw new Error("Can not get gcd");for(;;){const n=e%t|0;if(0===n)return t;e=t,t=n}}(a,48);return{time:e.realtime,name:`${e.timepointIndex+1} : ${1+(n/t|0)} : ${n%t+1}`,divide:`${a/i} / ${48/i}`}});return i.a.createElement("div",{className:e.root},i.a.createElement("div",{className:e.window},t&&i.a.createElement(i.a.Fragment,null,i.a.createElement("div",null,L(t.time)),i.a.createElement("div",null,t.name),i.a.createElement("div",null,t.divide))))};const uo=({from:e,to:t,layerWidth:n})=>{const o=wi(),r=Object(ot.a)(()=>{const a=e.realtimecache*ti.timeHeightFactor,i=t.realtimecache*ti.timeHeightFactor-a,o=n*(e.lane-t.lane)*.1;return{bottom:a+"px",height:i+"px",transform:`skew(${Math.atan2(o,i)}rad)`,left:5*(e.lane+t.lane)+15+"%"}}),s=e.slide,l=Object(a.useMemo)(()=>(e=>t=>{const n=Ai.pointerBeat,a=Ai.pointerLane;!n||a<0||(t.stopPropagation(),Ie.map.addSlideMid(e,n.timepoint.id,n.offset,a))})(s),[s]);return i.a.createElement("div",{className:o.slidebar,onClick:l,style:r})};var po=()=>{const e=vi(),t=Fi(),[n,o]=Object(a.useState)(100);Object(a.useEffect)(()=>{const e=()=>Ai.panelRef.current&&o(Ai.panelRef.current.clientWidth),t=Object(z.c)(e);return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e),t()}},[]);const r=Object(ot.a)(()=>{const e=[];return(e=>{for(const t of Ie.map.slidelist){let n=_(Ie.map.notes.get(t.notes[0]));for(let a=1;a<t.notes.length;a++){const i=_(Ie.map.notes.get(t.notes[a]));e(n,i),n=i}}})((t,a)=>e.push(i.a.createElement(uo,{key:t.id+":"+a.id,from:t,to:a,layerWidth:n}))),e});return i.a.createElement("div",{className:e.layer,ref:t},r)};const ho=({noteid:e})=>{const t=wi(),n=Object(ot.a)(()=>{const t=Ie.map.notes.get(e);if(t)return{bottom:t.realtimecache*ti.timeHeightFactor+"px",left:10*t.lane+15+"%",color:"#ff8800",transform:"translateY(50%) scale(1.4)"}});return n?i.a.createElement(Bi,{className:t.note+" "+t.noevent,style:n}):null};var go=()=>{const e=vi(),t=Fi(),n=Object(ot.a)(()=>ti.samePosNotes);return Object(a.useEffect)(()=>{n.size>0&&Yt(p.t("Some notes are in the same position"),"warning")},[n.size]),i.a.createElement("div",{className:e.layer,ref:t},P(n).map(e=>i.a.createElement(ho,{key:e,noteid:e})))};function fo(e,t,n){let a=0,i=t;if(t<=0)return[0,!1];if(n<e(a))return[0,!1];for(;a<i-1;){const t=(a+i)/2|0,o=e(t);if(n<o)i=t;else{if(!(o<n))return[t+1,!0];a=t}}return[a+1,e(a)===n]}const bo=e=>`translateY(${ti.timeHeightFactor*e}px)`,yo=Object(z.b)(e=>{e.stopPropagation();const t=e.deltaY/ti.timeHeightFactor,n=ti.getViewposition()-t;ti.setViewposition(n)}),Eo=Object(z.b)(e=>{if("buttons"in e)Ai.pointerClientX=e.clientX,Ai.pointerClientY=e.clientY;else{const t=Array.from(e.changedTouches);if(t.length<=0)return;Ai.pointerClientX=t.reduce((e,t)=>e+t.clientX,0)/t.length,Ai.pointerClientY=t.reduce((e,t)=>e+t.clientY,0)/t.length}});let vo=-1;const wo=Object(z.b)(e=>{if(e.stopPropagation(),e.preventDefault(),document.activeElement&&"blur"in document.activeElement&&document.activeElement.blur(),vo<0)if("buttons"in e){if(!(3&e.buttons))return;vo=e.button}else vo=e.changedTouches[0].identifier;Eo(e),Ai.selectingStartLeft=Ai.pointerLeftPercent,Ai.selectingStartTime=Ai.pointerTime,e.ctrlKey||Ai.selectedNotes.clear()}),Oo=Object(z.b)(()=>{if(Ai.selecting){vo=-1,Ai.selecting=!1;for(const e of Ai.selectingNotes)Ai.selectedNotes.add(e);Ai.selectingNotes=[],Ai.preventClick++,setTimeout(()=>Ai.preventClick--,50)}});window.addEventListener("mouseup",e=>{e.button===vo&&Oo()}),window.addEventListener("touchend",e=>{e.changedTouches[0].identifier===vo&&Oo()});const jo=Object(z.b)(e=>{if(Eo(e),!("buttons"in e)||3&e.buttons?Ai.draggingNote<0&&!Ai.selecting&&(Math.abs(Ai.pointerTime-Ai.selectingStartTime)>50/ti.timeHeightFactor||Math.abs(Ai.pointerLeftPercent-Ai.selectingStartLeft)>10)&&(Ai.selecting=!0,Ai.slideNote1Beat=void 0):Ai.selecting&&Oo(),Ai.selecting){const e=ti.noteListOrdered,t=fo(t=>e[t].realtimecache,e.length,Ai.pointerTime)[0],n=fo(t=>e[t].realtimecache,e.length,Ai.selectingStartTime)[0];Ai.selectingNotes=e.slice(Math.min(t,n),Math.max(t,n)).filter(e=>{const t=10*e.lane+20,n=Math.min(Ai.pointerLeftPercent,Ai.selectingStartLeft),a=Math.max(Ai.pointerLeftPercent,Ai.selectingStartLeft);return t>=n&&t<=a}).map(e=>e.id)}}),ko=Object(z.b)(e=>{if(Eo(e.nativeEvent),e.stopPropagation(),e.preventDefault(),Ai.preventClick)return;const t=Ai.pointerBeat,n=Ai.pointerLane;if(t&&!(n<0))switch(ti.tool){case"single":Ie.map.addSingle(t.timepoint.id,t.offset,n);break;case"slide":Ai.slideNote1Beat?(Ie.map.addSlide(Ai.slideNote1Beat.timepoint.id,Ai.slideNote1Beat.offset,Ai.slideNote1Lane,t.timepoint.id,t.offset,n),Ai.slideNote1Beat=void 0):(Ai.slideNote1Beat=t,Ai.slideNote1Lane=n);break;default:return}});var _o=()=>{const e=vi();return Object(a.useEffect)(()=>Object(z.c)(()=>{Ai.panelRef.current&&(Ai.panelRef.current.style.height=ti.paddedDuration*ti.timeHeightFactor+"px",it.playing&&ti.tracking?ta(Ai.panelRef.current,"transform",ti.getViewposition(),ti.viewduration,bo,it.remaintime()):ea(Ai.panelRef.current,"transform",ti.getViewposition(),bo))}),[]),Object(a.useEffect)(()=>(window.addEventListener("mousedown",wo),window.addEventListener("mousemove",jo),()=>{window.removeEventListener("mousedown",wo),window.removeEventListener("mousemove",jo)}),[]),i.a.createElement("div",{className:e.track},i.a.createElement("div",{className:e.panel,ref:Ai.panelRef,onWheel:yo,onClick:ko},i.a.createElement(Qi,null),i.a.createElement(po,null),i.a.createElement(io,null),Ie.settings.editor.warn_for_same_pos_notes&&i.a.createElement(go,null),i.a.createElement(Yi,null)),Ie.settings.editor.show_info_window&&i.a.createElement(mo,null),i.a.createElement(lo,null))};const No=e=>10*e+15,So=e=>30*(ti.paddedDuration-e);function xo(e,t,n,a){e.beginPath(),e.moveTo(t,a),e.lineTo(n,a),e.stroke()}function Co(e,t,n,a,i){e.beginPath(),e.lineTo(t,n),e.lineTo(t+10,n),e.lineTo(a+10,i),e.lineTo(a,i),e.fill()}function To(e,t,n){e.beginPath(),e.lineTo(t,n),e.lineTo(t+5,n+3),e.lineTo(t+10,n),e.lineTo(t+5,n-3),e.fill()}function Po(e,t,n){e.beginPath(),e.lineTo(t,n),e.arcTo(t+5,n+5,t+10,n,7),e.arcTo(t+5,n-5,t,n,7),e.fill()}function Lo(e,t,n){e.beginPath(),e.ellipse(t,n,5,5,0,0,2*Math.PI),e.fill()}var Mo,Ro;const Ao=new(Mo=class{constructor(){Object(w.a)(this,"containerHeight",Ro,this),this.progressTransY=e=>`translateY(${-30*e}px)`,this.barTransY=e=>{const t=this.barHeight;if(t<=this.containerHeight)return"";const n=e/ti.paddedDuration;return`translateY(${-(this.containerHeight*n-t*n)}px)`},this.viewTransY=e=>{let t=this.containerHeight;return this.barHeight<this.containerHeight&&(t=this.barHeight),`translateY(${-(t*e/ti.paddedDuration)}px)`}}get barHeight(){return 30*ti.paddedDuration}get viewportheight(){return this.containerHeight/ti.timeHeightFactor*30}},Ro=Object(O.a)(Mo.prototype,"containerHeight",[z.g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Object(O.a)(Mo.prototype,"barHeight",[z.d],Object.getOwnPropertyDescriptor(Mo.prototype,"barHeight"),Mo.prototype),Object(O.a)(Mo.prototype,"viewportheight",[z.d],Object.getOwnPropertyDescriptor(Mo.prototype,"viewportheight"),Mo.prototype),Mo),Fo=Object(b.a)(e=>({progress:{position:"absolute",width:"100%",borderBottom:"2px solid red",bottom:0,willChange:"transform",opacity:.7}}));var Do=()=>{const e=Fo(),t=Object(a.useRef)(null);return Object(a.useEffect)(()=>Object(z.c)(()=>{if(t.current){const e=it.position();it.playing?ta(t.current,"transform",e,it.duration,Ao.progressTransY,it.remaintime()):ea(t.current,"transform",e,Ao.progressTransY)}}),[]),i.a.createElement("div",{className:e.progress,ref:t})};const Bo=Object(b.a)(e=>({bar:{position:"absolute",width:"100%",bottom:0,willChange:"transform"},canvas:{width:"100%",height:"100%"}})),Ho=Object(z.g)({current:null});Object(z.c)(()=>{Ho.current&&(Ho.current.height=Ao.barHeight,(e=>{const t=e.getContext("2d");if(!t)return;const n=R(0,ti.paddedDuration,2);t.clearRect(0,0,e.width,e.height),t.font="12px",t.lineWidth=1,t.strokeStyle="gray";for(const a of ni())xo(t,15,85,So(a.time));t.fillStyle="aquamarine",t.strokeStyle="aquamarine";for(const a of Ie.map.timepointlist){const e=So(a.time);xo(t,0,100,e),t.fillText(a.bpm+"",80,e-3)}t.fillStyle="white";for(const a of n)t.fillText(L(a).split(".")[0],0,So(a)-3);t.fillStyle="rgb(173,255,47,0.2)";for(const a of Ie.map.slidelist){let e,n=_(Ie.map.notes.get(a.notes[0]));for(let i=1;i<a.notes.length;i++)e=_(Ie.map.notes.get(a.notes[i])),Co(t,No(n.lane),So(n.realtimecache),No(e.lane),So(e.realtimecache)),n=e}for(const a of Ie.map.notelist)switch(a.type){case"single":t.fillStyle="rgba(21,224,225)",Po(t,No(a.lane),So(a.realtimecache));break;case"flick":t.fillStyle="rgba(255,59,114)",To(t,No(a.lane),So(a.realtimecache));break;case"slide":const e=_(Ie.map.slides.get(a.slide));if(t.fillStyle="rgba(1,219,1)",a.id===e.notes[0])Po(t,No(a.lane),So(a.realtimecache));else if(a.id===e.notes[e.notes.length-1])e.flickend?(t.fillStyle="rgba(255,59,114)",To(t,No(a.lane),So(a.realtimecache))):Po(t,No(a.lane),So(a.realtimecache));else{t.strokeStyle="rgba(1,219,1)",t.lineWidth=2;const e=No(a.lane);xo(t,e,e+10,So(a.realtimecache))}}})(Ho.current),Ie.settings.editor.warn_for_same_pos_notes&&(e=>{const t=e.getContext("2d");if(t){t.fillStyle="#ff8800";for(const e of ti.samePosNotes){const n=Ie.map.notes.get(e);if(!n)return;Lo(t,93,So(n.realtimecache))}}})(Ho.current))});const zo=()=>{const e=Bo(),t=Object(a.useRef)(null);return Object(a.useEffect)(()=>(Ho.current=t.current,()=>{Ho.current=null}),[]),i.a.createElement("canvas",{ref:t,className:e.canvas,width:100})},Wo=e=>{let t;if("buttons"in e){if(!(3&e.buttons))return;t=e.clientY}else t=e.changedTouches[0].clientY;const n=(e.currentTarget.getBoundingClientRect().bottom-t-Ao.viewportheight/2)/Ao.barHeight*ti.paddedDuration;ti.setViewposition(n)};var Io=()=>{const e=Bo(),t=Object(a.useRef)(null);return Object(a.useEffect)(()=>Object(z.c)(()=>{t.current&&(t.current.style.height=Ao.barHeight+"px",it.playing&&ti.tracking?ta(t.current,"transform",ti.getViewposition(),ti.viewduration,Ao.barTransY,it.remaintime()):ea(t.current,"transform",ti.getViewposition(),Ao.barTransY))}),[]),i.a.createElement("div",{className:e.bar,ref:t,onTouchStart:Wo,onMouseDown:Wo},i.a.createElement(zo,null),i.a.createElement(Do,null))};const $o=Object(b.a)(e=>({viewport:{position:"absolute",width:"100%",backgroundColor:"#fff",opacity:.2,transition:"opacity 0.2s",bottom:0,willChange:"opacity, transform","&:hover":{opacity:.4}}})),Uo={identifier:-1,offsetY:0,container:null},Yo=e=>{e.stopPropagation();const t=e.currentTarget.getBoundingClientRect().bottom;if(Uo.identifier<0)if("buttons"in e){if(!(3&e.buttons))return;Uo.identifier=e.button,Uo.offsetY=t-e.clientY}else Uo.identifier=e.changedTouches[0].identifier,Uo.offsetY=t-e.changedTouches[0].clientY;Uo.container=e.currentTarget.parentElement},Vo=e=>{let t;if("buttons"in e){if(Uo.identifier!==e.button)return;t=e.clientY}else{if(Uo.identifier!==e.changedTouches[0].identifier)return;t=e.changedTouches[0].clientY}if(!Uo.container)return;e.stopPropagation();const n=Uo.container.getBoundingClientRect().bottom-t-Uo.offsetY;let a=Ao.containerHeight;Ao.barHeight<Ao.containerHeight&&(a=Ao.barHeight);let i=n/a*ti.paddedDuration;ti.setViewposition(i)};window.addEventListener("mouseup",()=>Uo.identifier=-1),window.addEventListener("mouseleave",()=>Uo.identifier=-1),document.addEventListener("mousemove",Vo),document.addEventListener("touchmove",Vo);var Jo=()=>{const e=$o(),t=Object(a.useRef)(null);return Object(a.useEffect)(()=>Object(z.c)(()=>{t.current&&(t.current.style.height=Ao.viewportheight+"px",it.playing&&ti.tracking?ta(t.current,"transform",ti.getViewposition(),ti.viewduration,Ao.viewTransY,it.remaintime()):ea(t.current,"transform",ti.getViewposition(),Ao.viewTransY))}),[]),i.a.createElement("div",{className:e.viewport,ref:t,onMouseDown:Yo,onTouchStart:Yo})};const Go=Object(b.a)(e=>({scrollbar:{position:"relative",width:100}})),Xo=e=>{e.stopPropagation();const t=e.deltaY/100,n=ti.getViewposition()-t;ti.setViewposition(n)};var qo=()=>{const e=Go(),t=Object(a.useRef)(null);return Object(a.useEffect)(()=>{const e=()=>t.current&&(Ao.containerHeight=t.current.clientHeight);return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),i.a.createElement("div",{className:e.scrollbar,ref:t,onWheel:Xo},i.a.createElement(Io,null),i.a.createElement(Jo,null))};const Ko=M(()=>({perfect:Ye.from(nt(Xn.perfect)).load(),flick:Ye.from(nt(Xn.flick)).load()})),Qo=M(()=>{["note_flick","note_long","note_normal","note_slide_among"].forEach(async e=>{const t=await fetch(Xn[e]),n=await t.blob();Xn[e]=URL.createObjectURL(n)})});let Zo=-1;const er=Object(z.g)({get list(){return ti.noteListOrdered.map(e=>{if("single"===e.type)return{time:e.realtimecache,type:"single"};if("flick"===e.type)return{time:e.realtimecache,type:"flick"};const t=_(Ie.map.slides.get(e.slide));return e.id===t.notes[t.notes.length-1]&&t.flickend?{time:e.realtimecache,type:"flick"}:{time:e.realtimecache,type:"single"}})}}),tr=new Set;function nr(){if(it.playing){const e=er.list,t=it.position();if(e.length<=0)return;let[n]=fo(t=>e[t].time,e.length,t);for(;n<e.length&&e[n].time<=t;)n++;if(n>=e.length)return;const a=e[n].time;if(a>t+.05)return;if(a<Zo)return;Zo=a+.01*it.playbackrate;const i=Ko();for(;n<e.length&&e[n].time<Zo;){const a=new Ve("single"===e[n].type?i.perfect:i.flick);a.play((e[n].time-t)/it.playbackrate),a.onend.add(()=>tr.delete(a)),tr.add(a),n++}}else{Zo=-1;for(const e of P(tr))e.stop();tr.clear()}}Object(z.c)(()=>{it.position()&&(Zo=-1)});const ar=Object(b.a)(e=>({root:{position:"absolute",width:"100%",height:"100%",display:"flex",justifyContent:"space-between",alignItems:"stretch",overflow:"hidden"}}));const ir={"#meta":Fn,"#timing":Ta,"#mapping":()=>{const e=ar();return Object(a.useEffect)(()=>{Qo()},[]),Object(a.useEffect)(()=>Kn(nr),[]),Object(a.useEffect)(()=>Object(z.c)(()=>{const e=Ko();e.perfect.volume=Ie.settings.general.effect_volume,e.flick.volume=Ie.settings.general.effect_volume}),[]),i.a.createElement(h.a,{className:e.root,onContextMenu:e=>{e.stopPropagation(),e.preventDefault()}},i.a.createElement(Ei,null),i.a.createElement(_o,null),i.a.createElement(qo,null))},"#settings":Za},or=Object(z.g)({path:window.location.hash||"#meta"});Object(z.h)(()=>or.path,e=>window.location.hash=e);const rr=()=>{const e=Object(ot.a)(()=>or.path),t=ir[e];return Object(a.useEffect)(()=>{t||(or.path="#meta")},[t]),[e,t||(()=>null)]},sr=Object(b.a)(e=>({content:{flexGrow:1,position:"relative",overflow:"hidden"},wrapping:{width:"100%",height:"100%",overflowX:"hidden",overflowY:"auto","-webkit-overflow-scrolling":"touch",position:"absolute"}}));var lr=()=>{const e=sr(),[t,n]=rr();return i.a.createElement(f.a,{in:!0,key:t},i.a.createElement(h.a,{className:e.content},i.a.createElement(h.a,{className:e.wrapping},i.a.createElement(n,null))))},cr=n(453),mr=n(457),ur=n(202),dr=n.n(ur),pr=n(201),hr=n.n(pr),gr=n(198),fr=n.n(gr),br=n(200),yr=n.n(br),Er=n(199),vr=n.n(Er);let wr=()=>{};function Or(){window.history.pushState({},"","#game"),wr()}const jr=Object(b.a)(e=>({tabs:{flexGrow:1,height:"100%"}})),kr=()=>{const e=jr(),{t:t}=Object(l.b)(),[n]=rr(),a={"#meta":t("Meta"),"#timing":t("Timing"),"#mapping":t("Mapping"),"#settings":t("Settings")};return i.a.createElement(mr.a,{indicatorColor:"primary",className:e.tabs,value:n in a?n:"#meta",onChange:(e,t)=>(e=>or.path=e)(t)},Object.keys(a).map(e=>i.a.createElement(cr.a,{key:e,value:e,label:a[e]})))},_r=e=>{Ie.save(),e.preventDefault(),Yt(p.t("Saved into browser storage"),"success")},Nr=()=>{const[e,t]=Object(a.useState)(0),n=Object(ot.a)(()=>Ie.lastSave);return Object(a.useEffect)(()=>{if(!n||n.getTime()===e)return;const a=setTimeout(()=>{t(n.getTime())},3e3);return()=>clearTimeout(a)}),n&&n.getTime()!==e?i.a.createElement(vr.a,null):i.a.createElement(fr.a,null)},Sr=()=>{Object(a.useEffect)(()=>Qn("ctrl+z",Ie.map.Undo),[]),Object(a.useEffect)(()=>Qn("ctrl+shift+z",Ie.map.Redo),[]),Object(a.useEffect)(()=>Qn("ctrl+s",_r),[]);const{t:e}=Object(l.b)(),t=Object(ot.a)(()=>[{children:i.a.createElement(yr.a,null),onClick:Ie.map.Undo,disabled:!Ie.map.canUndo,title:e("Hotkey: {{ hotkey }}",{hotkey:"ctrl + z"})},{children:i.a.createElement(hr.a,null),onClick:Ie.map.Redo,disabled:!Ie.map.canRedo,title:e("Hotkey: {{ hotkey }}",{hotkey:"ctrl + shift + z"})},{children:i.a.createElement(Nr,null),onClick:_r,title:e("Hotkey: {{ hotkey }}",{hotkey:"ctrl + s"})}]),n=[{children:i.a.createElement(dr.a,null),onClick:Or}];return i.a.createElement(i.a.Fragment,null,t.map((e,t)=>i.a.createElement(h.a,{key:t},i.a.createElement(Dt.a,e))),i.a.createElement(h.a,{width:2}),n.map((e,t)=>i.a.createElement(h.a,{key:t},i.a.createElement(Dt.a,e))))};var xr=()=>i.a.createElement(i.a.Fragment,null,i.a.createElement(kr,null),i.a.createElement(Sr,null));const Cr=Object(b.a)(e=>({flex:{display:"flex",alignItems:"center"},center:{justifyContent:"center"},bar:{flexGrow:1,height:"100%",position:"relative"},time:{margin:e.spacing(0,2),width:80,textAlign:"center"},layer:{position:"absolute",width:"100%",height:"100%"},midline:{width:"100%",borderBottom:"1px solid white"},progress:{position:"absolute",height:"100%",borderLeft:"4px solid red"},timepoint:{position:"absolute",height:"50%",borderLeft:"1px solid aquamarine",transition:"left 0.2s"}})),Tr=()=>{const e=Cr();return Object(ot.a)(()=>i.a.createElement(i.a.Fragment,null,Ie.map.timepointlist.map(t=>{return i.a.createElement("div",{key:t.id,className:e.timepoint,style:{left:(n=t.time,`${n/it.duration*100}%`)}});var n})))},Pr=()=>{const e=Cr(),t=Object(a.useRef)(null);return Object(a.useEffect)(()=>Object(z.c)(()=>{if(t.current){const e=it.position()/it.duration;it.playing?ta(t.current,"left",100*e,100,"%",it.remaintime()):ea(t.current,"left",100*e,"%")}}),[]),i.a.createElement("div",{className:e.progress,ref:t})},Lr=()=>{const e=Cr(),t=Object(a.useRef)(null),n=Object(a.useRef)(-1);return Object(a.useEffect)(()=>Kn(()=>{const e=it.position();t.current&&n.current!==e&&(t.current.innerText=L(e),n.current=e)}),[]),i.a.createElement("div",{className:Object(_t.a)(e.flex,e.center,e.time),ref:t})},Mr=e=>{if(!(3&e.buttons))return;const t=e.currentTarget,n=e.pageX-t.offsetLeft;it.seek(n/t.clientWidth*it.duration)},Rr=e=>{const t=e.currentTarget,n=e.changedTouches[0].pageX-t.offsetLeft;it.seek(n/t.clientWidth*it.duration)},Ar=e=>{e.stopPropagation();const t=e.deltaY/100,n=it.position()-t;it.seek(n)};var Fr=()=>{const e=Cr();return Object(ot.a)(()=>i.a.createElement("div",{className:Object(_t.a)(e.flex,e.bar),style:{overflow:"hidden"},onWheel:Ar},i.a.createElement(Lr,null),i.a.createElement("div",{className:e.bar,onMouseDown:Mr,onMouseMove:Mr,onTouchStart:Rr,onTouchMove:Rr},i.a.createElement("div",{className:Object(_t.a)(e.flex,e.layer,e.center)},i.a.createElement("div",{className:e.midline})),i.a.createElement("div",{className:e.layer},i.a.createElement(Tr,null)),i.a.createElement("div",{className:e.layer},i.a.createElement(Pr,null))),i.a.createElement("div",{className:Object(_t.a)(e.flex,e.center,e.time)},L(it.duration))))},Dr=n(205),Br=n.n(Dr),Hr=n(203),zr=n.n(Hr),Wr=n(204),Ir=n.n(Wr);var $r=()=>{const{t:e}=Object(l.b)();return Object(a.useEffect)(()=>Qn("space",it.toggle),[]),Object(ot.a)(()=>i.a.createElement(i.a.Fragment,null,i.a.createElement(Dt.a,{onClick:it.toggle,disabled:!it.loaded,title:e("Hotkey: {{ hotkey }}",{hotkey:"space"})},it.playing?i.a.createElement(zr.a,null):i.a.createElement(Ir.a,null)),i.a.createElement(Dt.a,{onClick:it.stop,disabled:!it.loaded},i.a.createElement(Br.a,null)),i.a.createElement(h.a,{width:"120px",ml:3,mr:4},i.a.createElement(Pa.a,{value:it.playbackrate,step:null,min:.15,max:1,title:e("Playback rate"),color:"secondary",onChange:(e,t)=>it.playbackrate=t,marks:[{value:.25,label:"25%"},{value:.5,label:"50%"},{value:.75,label:"75%"},{value:1,label:"100%"}]}))))};var Ur=()=>i.a.createElement(i.a.Fragment,null,i.a.createElement(Fr,null),i.a.createElement($r,null));const Yr=Object(b.a)(e=>({content:{position:"fixed",display:"flex",flexDirection:"column",top:0,bottom:0,left:0,right:0},bar:{display:"flex",alignItems:"center",height:50,width:"100%",backgroundColor:"rgba(128, 128, 128, 0.4)"}}));var Vr=()=>{const e=Yr();return Object(a.useEffect)(()=>()=>{it.playing&&it.toggle()},[]),i.a.createElement(y.a,{theme:ut},i.a.createElement(g.a,null),i.a.createElement(f.a,{in:!0},i.a.createElement(h.a,{className:e.content},i.a.createElement(st,null),i.a.createElement(h.a,{className:e.bar},i.a.createElement(xr,null)),i.a.createElement(lr,null),i.a.createElement(h.a,{className:e.bar},i.a.createElement(Ur,null)))),i.a.createElement(Jt,null))},Jr=n(206);const Gr=Object(b.a)(e=>({root:{position:"fixed",left:0,right:0,top:0,bottom:0},canvas:{width:"100%",height:"100%"}}));var Xr=()=>{const e=Gr(),t=Object(a.useRef)(null),n=Object(a.useRef)(null);return Object(a.useEffect)(()=>{if(!n.current)return;if(!it.musicfile)return window.history.back(),void setTimeout(()=>{Yt(p.t("No music selected"))},100);const e=URL.createObjectURL(it.musicfile),t=new Jr.Game(n.current,{judgeOffset:Ie.settings.game.judge_offset,visualOffset:Ie.settings.game.visual_offset,speed:Ie.settings.game.speed,resolution:Ie.settings.game.resolution,noteScale:Ie.settings.game.note_scale,barOpacity:Ie.settings.game.bar_opaciry,backgroundDim:Ie.settings.general.background_dim,effectVolume:Ie.settings.general.effect_volume,showSimLine:Ie.settings.game.show_sim_line,laneEffect:Ie.settings.game.lane_effect,mirror:Ie.settings.game.mirror,beatNote:Ie.settings.game.beat_note},{musicSrc:e,backgroundSrc:at.src||"/ebbb/assets/mapping/bg_normal.png",songName:Ie.meta.name,skin:"/ebbb/assets/skins/"+Ie.settings.game.skin,sound:"/ebbb/assets/skins/"+Ie.settings.game.skin,mapContent:()=>function(e){const t=[],n=[],a={};for(const[i,o]of e.slides)a[i]=n.length,n.push({id:n.length,flickend:o.flickend});for(const[,i]of e.notes)"single"===i.type?t.push({type:"single",time:i.realtimecache,lane:i.lane,onbeat:i.offset%24===0}):"flick"===i.type?t.push({type:"flick",time:i.realtimecache,lane:i.lane}):t.push({type:"slide",time:i.realtimecache,lane:i.lane,slideid:a[i.slide]});return{notes:t,slides:n}}(Ie.map)});return t.ondestroyed=()=>{window.history.back()},t.start(),()=>{URL.revokeObjectURL(e)}},[]),i.a.createElement("div",{ref:t,className:e.root},i.a.createElement("canvas",{ref:n,className:e.canvas}))};var qr=()=>(Object(a.useEffect)(()=>{var e,t;null===(e=document.getElementById("loader"))||void 0===e||e.remove(),null===(t=document.getElementById("loader-style"))||void 0===t||t.remove(),gtag("event","timing_complete",{name:"app_load",value:performance.now()})},[]),function(){const[e,t]=Object(a.useState)("");return Object(a.useEffect)(()=>{const e=()=>{t(window.location.hash)};return wr=e,window.addEventListener("popstate",e),()=>window.addEventListener("popstate",e)},[]),"#game"===e}()?i.a.createElement(Xr,null):i.a.createElement(Vr,null));const Kr=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function Qr(e,t){navigator.serviceWorker.register(e).then(e=>{e.onupdatefound=()=>{const n=e.installing;null!=n&&(n.onstatechange=()=>{"installed"===n.state&&(navigator.serviceWorker.controller?(console.log("New content is available and will be used when all tabs for this page are closed. See https://bit.ly/CRA-PWA."),window.addEventListener("beforeunload",()=>{n.postMessage({type:"SKIP_WAITING"})}),t&&t.onUpdate&&t.onUpdate(e)):(console.log("Content is cached for offline use."),t&&t.onSuccess&&t.onSuccess(e)))})}}).catch(e=>{console.error("Error during service worker registration:",e)})}window.addEventListener("error",e=>{gtag("event","exception",{description:e.error,fatal:!0})}),r.a.render(i.a.createElement(qr,null),document.getElementById("root")),function(e){if("serviceWorker"in navigator){if(new URL("/ebbb",window.location.href).origin!==window.location.origin)return;window.addEventListener("load",()=>{const t="/ebbb/service-worker.js";Kr?(!function(e,t){fetch(e,{headers:{"Service-Worker":"script"}}).then(n=>{const a=n.headers.get("content-type");404===n.status||null!=a&&-1===a.indexOf("javascript")?navigator.serviceWorker.ready.then(e=>{e.unregister().then(()=>{window.location.reload()})}):Qr(e,t)}).catch(()=>{console.log("No internet connection found. App is running in offline mode.")})}(t,e),navigator.serviceWorker.ready.then(()=>{console.log("This web app is being served cache-first by a service worker. To learn more, visit https://bit.ly/CRA-PWA")})):Qr(t,e)})}}({onUpdate(){Yt(p.t("An update is available. Please close ALL tabs of this site or press Ctrl + F5 reload."),"info"),Ie.update=!0}})}},[[226,1,2]]]);
//# sourceMappingURL=main.880fd1ae.chunk.js.map